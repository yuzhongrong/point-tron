# ä¸šåŠ¡æœåŠ¡æ‰©å±•æŒ‡å—

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [BlockDataService.ts](file://src/services/BlockDataService.ts)
- [TronRPCService.ts](file://src/services/TronRPCService.ts)
- [index.ts](file://src/index.ts)
- [types.ts](file://src/models/types.ts)
- [blocks.ts](file://src/routes/blocks.ts)
- [index.ts](file://src/config/index.ts)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æœåŠ¡æ¶æ„æ¦‚è§ˆ](#æœåŠ¡æ¶æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒæœåŠ¡è®¾è®¡åŸåˆ™](#æ ¸å¿ƒæœåŠ¡è®¾è®¡åŸåˆ™)
4. [ç°æœ‰æœåŠ¡åˆ†æ](#ç°æœ‰æœåŠ¡åˆ†æ)
5. [åˆ›å»ºæ–°æœåŠ¡ç±»çš„å®Œæ•´æŒ‡å—](#åˆ›å»ºæ–°æœåŠ¡ç±»çš„å®Œæ•´æŒ‡å—)
6. [æœåŠ¡é—´é€šä¿¡æœºåˆ¶](#æœåŠ¡é—´é€šä¿¡æœºåˆ¶)
7. [æœ€ä½³å®è·µæ¨¡æ¿](#æœ€ä½³å®è·µæ¨¡æ¿)
8. [é”™è¯¯å¤„ç†ä¸ç›‘æ§](#é”™è¯¯å¤„ç†ä¸ç›‘æ§)
9. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## ç®€ä»‹

æœ¬æ–‡æ¡£ä¸ºå¼€å‘è€…æä¾›äº†åˆ›å»ºæ–°çš„ä¸šåŠ¡æœåŠ¡ç±»çš„è¯¦ç»†æŒ‡å—ï¼Œé‡ç‚¹ä»‹ç»å¦‚ä½•åŸºäºç°æœ‰çš„BlockDataServiceå’ŒTronRPCServiceæ¨¡å¼æ¥æ‰©å±•ç³»ç»ŸåŠŸèƒ½ã€‚é€šè¿‡æ·±å…¥åˆ†æç°æœ‰æœåŠ¡çš„è®¾è®¡åŸç†å’Œå®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•æ„å»ºå¯ç»´æŠ¤ã€å¯æµ‹è¯•ä¸”é«˜æ€§èƒ½çš„ä¸šåŠ¡æœåŠ¡ã€‚

## æœåŠ¡æ¶æ„æ¦‚è§ˆ

ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä¸šåŠ¡æœåŠ¡ä½äºæ ¸å¿ƒå±‚ï¼Œè´Ÿè´£åè°ƒæ•°æ®è®¿é—®å±‚å’Œå¤–éƒ¨æœåŠ¡ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†ä»£ç çš„æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ã€‚

```mermaid
graph TB
subgraph "è¡¨ç°å±‚"
Routes[è·¯ç”±å±‚]
Controllers[æ§åˆ¶å™¨]
end
subgraph "ä¸šåŠ¡æœåŠ¡å±‚"
BlockDataService[åŒºå—æ•°æ®æœåŠ¡]
TronRPCService[TRON RPCæœåŠ¡]
AuthService[è®¤è¯æœåŠ¡]
end
subgraph "æ•°æ®è®¿é—®å±‚"
BlockModel[åŒºå—æ¨¡å‹]
DailyStatsModel[æ¯æ—¥ç»Ÿè®¡æ¨¡å‹]
UserModel[ç”¨æˆ·æ¨¡å‹]
end
subgraph "å¤–éƒ¨æœåŠ¡"
TRONNetwork[TRONç½‘ç»œ]
Database[(SQLiteæ•°æ®åº“)]
end
Routes --> Controllers
Controllers --> BlockDataService
Controllers --> AuthService
BlockDataService --> TronRPCService
BlockDataService --> BlockModel
BlockDataService --> DailyStatsModel
TronRPCService --> TRONNetwork
BlockModel --> Database
DailyStatsModel --> Database
UserModel --> Database
```

**å›¾è¡¨æ¥æº**
- [index.ts](file://src/index.ts#L1-L50)
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L30)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L1-L30)

## æ ¸å¿ƒæœåŠ¡è®¾è®¡åŸåˆ™

### å•ä¸€èŒè´£åŸåˆ™

æ¯ä¸ªä¸šåŠ¡æœåŠ¡éƒ½ä¸“æ³¨äºç‰¹å®šçš„åŠŸèƒ½é¢†åŸŸï¼Œé¿å…åŠŸèƒ½æ··æ‚å¯¼è‡´çš„å¤æ‚æ€§ã€‚

### å¯æµ‹è¯•æ€§è®¾è®¡

æœåŠ¡é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥æ”¶å¤–éƒ¨ä¾èµ–ï¼Œä½¿å¾—å•å…ƒæµ‹è¯•å˜å¾—ç®€å•ç›´æ¥ã€‚

### ä¾èµ–æ³¨å…¥æ¨¡å¼

æ‰€æœ‰å¤–éƒ¨ä¾èµ–éƒ½åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥ï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å†…éƒ¨åˆ›å»ºå®ä¾‹ã€‚

### å¼‚æ­¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

æœåŠ¡å…·æœ‰æ˜ç¡®çš„å¯åŠ¨(start)å’Œåœæ­¢(stop)ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ”¯æŒä¼˜é›…çš„èµ„æºç®¡ç†ã€‚

## ç°æœ‰æœåŠ¡åˆ†æ

### BlockDataService åˆ†æ

BlockDataService æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼Œè´Ÿè´£åŒºå—æ•°æ®çš„é‡‡é›†ã€å¤„ç†å’Œå­˜å‚¨ã€‚

```mermaid
classDiagram
class BlockDataService {
-tronRPCService : TronRPCService
-isRunning : boolean
-lastProcessedBlock : number
-statsCache : Object
+constructor(tronRPCService)
+start() Promise~void~
+stop() void
-onNewBlock(blockInfo) Promise~void~
-updateStatsCache(blockInfo) void
-refreshStatsCache() Promise~void~
+getStatus() Object
+getRealTimeStats() Promise~Object~
+syncBlocks(fromBlock, toBlock) Promise~number~
+healthCheck() Promise~Object~
}
class TronRPCService {
-rpcUrl : string
-pollingTimer : NodeJS.Timeout
-isPolling : boolean
+startPolling(callback) void
+stopPolling() void
+getLatestBlock() Promise~BlockInfo~
+getBlockByNumber(number) Promise~BlockInfo~
+testConnection() Promise~Object~
+getPollingStatus() Object
}
class BlockInfo {
+block_number : number
+block_hash : string
+timestamp : number
+last_digit : number
+is_odd : boolean
}
BlockDataService --> TronRPCService : "ä¾èµ–"
BlockDataService --> BlockInfo : "å¤„ç†"
TronRPCService --> BlockInfo : "æä¾›"
```

**å›¾è¡¨æ¥æº**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L8-L273)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L15-L258)
- [types.ts](file://src/models/types.ts#L1-L15)

### TronRPCService åˆ†æ

TronRPCService æä¾›ä¸TRONåŒºå—é“¾ç½‘ç»œçš„äº¤äº’èƒ½åŠ›ï¼Œå®ç°äº†è½®è¯¢æœºåˆ¶æ¥æŒç»­ç›‘æ§æ–°åŒºå—ã€‚

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant BlockDataService as "åŒºå—æ•°æ®æœåŠ¡"
participant TronRPCService as "TRON RPCæœåŠ¡"
participant TRONNetwork as "TRONç½‘ç»œ"
Client->>BlockDataService : å¯åŠ¨æœåŠ¡
BlockDataService->>TronRPCService : startPolling(callback)
TronRPCService->>TronRPCService : è®¾ç½®å®šæ—¶å™¨
loop æ¯3ç§’è½®è¯¢
TronRPCService->>TRONNetwork : getLatestBlock()
TRONNetwork-->>TronRPCService : BlockInfo
TronRPCService->>BlockDataService : onNewBlock(blockInfo)
BlockDataService->>BlockDataService : å¤„ç†åŒºå—æ•°æ®
BlockDataService->>BlockDataService : æ›´æ–°ç»Ÿè®¡
end
Client->>BlockDataService : åœæ­¢æœåŠ¡
BlockDataService->>TronRPCService : stopPolling()
TronRPCService->>TronRPCService : æ¸…ç†å®šæ—¶å™¨
```

**å›¾è¡¨æ¥æº**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L30-L50)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L30-L80)

**ç« èŠ‚æ¥æº**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L273)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L1-L258)

## åˆ›å»ºæ–°æœåŠ¡ç±»çš„å®Œæ•´æŒ‡å—

### æ­¥éª¤1ï¼šå®šä¹‰æœåŠ¡æ¥å£

é¦–å…ˆï¼Œä¸ºæ–°æœåŠ¡å®šä¹‰æ¸…æ™°çš„æ¥å£å¥‘çº¦ï¼š

```typescript
// æ–°æœåŠ¡æ¥å£ç¤ºä¾‹
export interface NewBlockchainService {
  start(): Promise<void>;
  stop(): void;
  getLatestBlock(): Promise<BlockInfo>;
  getBlockByNumber(blockNumber: number): Promise<BlockInfo>;
  healthCheck(): Promise<boolean>;
}
```

### æ­¥éª¤2ï¼šå®ç°æœåŠ¡ç±»

åŸºäºBlockDataServiceçš„æ¨¡å¼å®ç°æ–°æœåŠ¡ï¼š

```typescript
export class NewBlockchainService implements NewBlockchainService {
  private blockchainRpcService: BlockchainRpcService;
  private isRunning: boolean = false;
  private lastProcessedBlock: number = 0;
  private pollingTimer: NodeJS.Timeout | null = null;

  constructor(blockchainRpcService: BlockchainRpcService) {
    this.blockchainRpcService = blockchainRpcService;
  }

  public async start(): Promise<void> {
    if (this.isRunning) {
      console.warn('æœåŠ¡å·²åœ¨è¿è¡Œä¸­');
      return;
    }

    try {
      // åˆå§‹åŒ–é€»è¾‘
      await this.initializeService();
      
      // å¯åŠ¨è½®è¯¢
      this.startPolling();
      
      this.isRunning = true;
      console.log('âœ… æœåŠ¡å·²å¯åŠ¨');
      
    } catch (error) {
      console.error('å¯åŠ¨æœåŠ¡å¤±è´¥:', error);
      throw error;
    }
  }

  public stop(): void {
    if (!this.isRunning) {
      return;
    }

    this.stopPolling();
    this.isRunning = false;
    console.log('ğŸ›‘ æœåŠ¡å·²åœæ­¢');
  }

  private startPolling(): void {
    // å®ç°è½®è¯¢é€»è¾‘
  }

  private stopPolling(): void {
    // æ¸…ç†è½®è¯¢èµ„æº
  }

  private async initializeService(): Promise<void> {
    // æœåŠ¡åˆå§‹åŒ–é€»è¾‘
  }
}
```

### æ­¥éª¤3ï¼šé›†æˆåˆ°ä¸»åº”ç”¨

åœ¨ä¸»åº”ç”¨ä¸­æ³¨å†Œæ–°æœåŠ¡ï¼š

```typescript
// åœ¨Appç±»ä¸­æ·»åŠ æ–°æœåŠ¡
class App {
  private newBlockchainService: NewBlockchainService;

  constructor() {
    // ...
    this.newBlockchainService = new NewBlockchainService(this.blockchainRpcService);
  }

  public async start(): Promise<void> {
    // ...
    await this.newBlockchainService.start();
    // ...
  }

  public async shutdown(): Promise<void> {
    // ...
    this.newBlockchainService.stop();
    // ...
  }
}
```

**ç« èŠ‚æ¥æº**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L8-L50)
- [index.ts](file://src/index.ts#L15-L35)

## æœåŠ¡é—´é€šä¿¡æœºåˆ¶

### ä¾èµ–æ³¨å…¥é€šä¿¡

æœåŠ¡é—´é€šè¿‡ä¾èµ–æ³¨å…¥å»ºç«‹æ¾è€¦åˆå…³ç³»ï¼š

```mermaid
flowchart TD
App["åº”ç”¨ä¸»ç±»<br/>(App)"] --> TronRPCService["TRON RPCæœåŠ¡"]
App --> BlockDataService["åŒºå—æ•°æ®æœåŠ¡"]
App --> NewBlockchainService["æ–°åŒºå—é“¾æœåŠ¡"]
BlockDataService --> TronRPCService
NewBlockchainService --> TronRPCService
TronRPCService --> TRONNetwork["TRONç½‘ç»œ"]
NewBlockchainService --> OtherNetwork["å…¶ä»–ç½‘ç»œ"]
BlockDataService -.->|"å›è°ƒé€šçŸ¥"| App
NewBlockchainService -.->|"äº‹ä»¶ç›‘å¬"| App
```

**å›¾è¡¨æ¥æº**
- [index.ts](file://src/index.ts#L15-L35)
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L15-L25)

### å›è°ƒæœºåˆ¶

ä½¿ç”¨å›è°ƒå‡½æ•°å®ç°æœåŠ¡é—´çš„å¼‚æ­¥é€šä¿¡ï¼š

```typescript
// åœ¨BlockDataServiceä¸­ä½¿ç”¨å›è°ƒ
this.tronRPCService.startPolling(this.onNewBlock.bind(this));

// å›è°ƒå‡½æ•°å®ç°
private async onNewBlock(blockInfo: BlockInfo): Promise<void> {
  // å¤„ç†æ–°å—é€»è¾‘
}
```

**ç« èŠ‚æ¥æº**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L30-L50)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L30-L80)

## æœ€ä½³å®è·µæ¨¡æ¿

### å®Œæ•´çš„æœåŠ¡æ¨¡æ¿

ä»¥ä¸‹æ˜¯åˆ›å»ºæ–°ä¸šåŠ¡æœåŠ¡çš„æœ€ä½³å®è·µæ¨¡æ¿ï¼š

```typescript
// 1. å®šä¹‰æœåŠ¡æ¥å£
export interface IServiceTemplate {
  start(): Promise<void>;
  stop(): void;
  getStatus(): ServiceStatus;
  healthCheck(): Promise<ServiceHealth>;
}

// 2. å®ç°æœåŠ¡ç±»
export class ServiceTemplate implements IServiceTemplate {
  private serviceDeps: ServiceDependencies;
  private isRunning: boolean = false;
  private logger: Logger;
  private config: ServiceConfig;

  constructor(deps: ServiceDependencies, config?: Partial<ServiceConfig>) {
    this.serviceDeps = deps;
    this.config = { ...defaultConfig, ...config };
    this.logger = new Logger('ServiceTemplate');
  }

  public async start(): Promise<void> {
    if (this.isRunning) {
      this.logger.warn('æœåŠ¡å·²åœ¨è¿è¡Œä¸­');
      return;
    }

    try {
      await this.initializeResources();
      this.startMonitoring();
      this.isRunning = true;
      this.logger.info('æœåŠ¡å¯åŠ¨æˆåŠŸ');
      
    } catch (error) {
      this.logger.error('å¯åŠ¨æœåŠ¡å¤±è´¥:', error);
      throw error;
    }
  }

  public stop(): void {
    if (!this.isRunning) return;

    this.stopMonitoring();
    this.cleanupResources();
    this.isRunning = false;
    this.logger.info('æœåŠ¡å·²åœæ­¢');
  }

  private async initializeResources(): Promise<void> {
    // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥ç­‰èµ„æº
  }

  private startMonitoring(): void {
    // å¯åŠ¨ç›‘æ§å¾ªç¯
  }

  private stopMonitoring(): void {
    // åœæ­¢ç›‘æ§å¾ªç¯
  }

  private cleanupResources(): void {
    // æ¸…ç†æ‰€æœ‰èµ„æº
  }

  public getStatus(): ServiceStatus {
    return {
      isRunning: this.isRunning,
      config: this.config,
      metrics: this.collectMetrics()
    };
  }

  public async healthCheck(): Promise<ServiceHealth> {
    const checks = await Promise.all([
      this.checkDatabaseConnection(),
      this.checkExternalService(),
      this.checkResourceUsage()
    ]);

    return {
      healthy: checks.every(check => check.healthy),
      checks: checks
    };
  }

  private collectMetrics(): ServiceMetrics {
    // æ”¶é›†æœåŠ¡æŒ‡æ ‡
    return {};
  }

  private async checkDatabaseConnection(): Promise<HealthCheck> {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    return { healthy: true, message: 'æ•°æ®åº“è¿æ¥æ­£å¸¸' };
  }

  private async checkExternalService(): Promise<HealthCheck> {
    // æ£€æŸ¥å¤–éƒ¨æœåŠ¡è¿æ¥
    return { healthy: true, message: 'å¤–éƒ¨æœåŠ¡è¿æ¥æ­£å¸¸' };
  }

  private async checkResourceUsage(): Promise<HealthCheck> {
    // æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ
    return { healthy: true, message: 'èµ„æºä½¿ç”¨æ­£å¸¸' };
  }
}
```

### å¼‚æ­¥åˆå§‹åŒ–æ¨¡å¼

```typescript
// å¼‚æ­¥åˆå§‹åŒ–ç¤ºä¾‹
private async initializeAsync(): Promise<void> {
  try {
    // å¹¶è¡Œåˆå§‹åŒ–å¤šä¸ªç»„ä»¶
    await Promise.all([
      this.initializeDatabase(),
      this.initializeCache(),
      this.initializeExternalServices()
    ]);
    
    // è®¾ç½®å®šæ—¶ä»»åŠ¡
    this.setupPeriodicTasks();
    
  } catch (error) {
    this.logger.error('å¼‚æ­¥åˆå§‹åŒ–å¤±è´¥:', error);
    throw error;
  }
}
```

### é”™è¯¯å¤„ç†æ¨¡å¼

```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†ç¤ºä¾‹
private async handleOperation<T>(
  operation: () => Promise<T>,
  context: string
): Promise<T | null> {
  try {
    return await operation();
  } catch (error) {
    this.logger.error(`${context}æ“ä½œå¤±è´¥:`, error);
    
    // æ ¹æ®é”™è¯¯ç±»å‹é‡‡å–ä¸åŒæªæ–½
    if (error instanceof NetworkError) {
      await this.handleNetworkError(error);
    } else if (error instanceof TimeoutError) {
      await this.handleTimeoutError(error);
    }
    
    return null;
  }
}
```

## é”™è¯¯å¤„ç†ä¸ç›‘æ§

### é”™è¯¯åˆ†ç±»å¤„ç†

ç³»ç»Ÿå®ç°äº†å¤šå±‚æ¬¡çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```mermaid
flowchart TD
Error["é”™è¯¯å‘ç”Ÿ"] --> ErrorType{"é”™è¯¯ç±»å‹åˆ¤æ–­"}
ErrorType --> |ç½‘ç»œé”™è¯¯| NetworkHandler["ç½‘ç»œé”™è¯¯å¤„ç†å™¨"]
ErrorType --> |è¶…æ—¶é”™è¯¯| TimeoutHandler["è¶…æ—¶é”™è¯¯å¤„ç†å™¨"]
ErrorType --> |æ•°æ®åº“é”™è¯¯| DBHandler["æ•°æ®åº“é”™è¯¯å¤„ç†å™¨"]
ErrorType --> |ä¸šåŠ¡é€»è¾‘é”™è¯¯| BusinessHandler["ä¸šåŠ¡é€»è¾‘é”™è¯¯å¤„ç†å™¨"]
ErrorType --> |æœªçŸ¥é”™è¯¯| UnknownHandler["æœªçŸ¥é”™è¯¯å¤„ç†å™¨"]
NetworkHandler --> RetryLogic["é‡è¯•é€»è¾‘"]
TimeoutHandler --> BackoffStrategy["æŒ‡æ•°é€€é¿ç­–ç•¥"]
DBHandler --> FallbackDB["é™çº§æ•°æ®åº“"]
BusinessHandler --> ValidationLayer["éªŒè¯å±‚"]
UnknownHandler --> AlertSystem["å‘Šè­¦ç³»ç»Ÿ"]
RetryLogic --> LogError["è®°å½•é”™è¯¯"]
BackoffStrategy --> LogError
FallbackDB --> LogError
ValidationLayer --> LogError
AlertSystem --> LogError
LogError --> MonitorSystem["ç›‘æ§ç³»ç»Ÿ"]
```

### æ—¥å¿—è®°å½•æœ€ä½³å®è·µ

```typescript
// ç»“æ„åŒ–æ—¥å¿—è®°å½•
private logOperation(operation: string, data: any = {}): void {
  this.logger.info(operation, {
    timestamp: new Date().toISOString(),
    service: 'ServiceTemplate',
    operation: operation,
    ...data
  });
}

// é”™è¯¯æ—¥å¿—è®°å½•
private logError(operation: string, error: Error, data: any = {}): void {
  this.logger.error(`${operation}å¤±è´¥`, {
    timestamp: new Date().toISOString(),
    service: 'ServiceTemplate',
    operation: operation,
    error: error.message,
    stack: error.stack,
    ...data
  });
}
```

**ç« èŠ‚æ¥æº**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L100-L150)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L100-L150)

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å†…å­˜ç®¡ç†

1. **åŠæ—¶æ¸…ç†å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨**
2. **é¿å…å†…å­˜æ³„æ¼çš„é—­åŒ…å¼•ç”¨**
3. **åˆç†ä½¿ç”¨å¯¹è±¡æ± å’Œç¼“å­˜**

### å¹¶å‘æ§åˆ¶

```typescript
// é™æµå™¨å®ç°
class RateLimiter {
  private requests: number = 0;
  private lastReset: number = Date.now();
  private maxRequests: number;
  private windowMs: number;

  constructor(maxRequests: number = 100, windowMs: number = 60000) {
    this.maxRequests = maxRequests;
    this.windowMs = windowMs;
  }

  public async wait(): Promise<void> {
    const now = Date.now();
    
    // é‡ç½®è®¡æ•°å™¨
    if (now - this.lastReset > this.windowMs) {
      this.requests = 0;
      this.lastReset = now;
    }

    if (this.requests >= this.maxRequests) {
      const waitTime = this.windowMs - (now - this.lastReset);
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }

    this.requests++;
  }
}
```

### ç¼“å­˜ç­–ç•¥

```typescript
// æ™ºèƒ½ç¼“å­˜å®ç°
class IntelligentCache<T> {
  private cache: Map<string, { value: T; expires: number }>;
  private ttl: number;

  constructor(ttl: number = 300000) { // é»˜è®¤5åˆ†é’Ÿ
    this.cache = new Map();
    this.ttl = ttl;
  }

  public set(key: string, value: T): void {
    const expires = Date.now() + this.ttl;
    this.cache.set(key, { value, expires });
  }

  public get(key: string): T | undefined {
    const item = this.cache.get(key);
    if (!item) return undefined;

    if (Date.now() > item.expires) {
      this.cache.delete(key);
      return undefined;
    }

    return item.value;
  }

  public invalidate(pattern: RegExp): void {
    for (const [key] of this.cache) {
      if (pattern.test(key)) {
        this.cache.delete(key);
      }
    }
  }
}
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ä¾èµ–æœåŠ¡æ˜¯å¦å¯ç”¨
   - éªŒè¯é…ç½®å‚æ•°æ­£ç¡®æ€§
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯å †æ ˆ

2. **å†…å­˜æ³„æ¼**
   - ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·æ£€æµ‹
   - æ£€æŸ¥å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®æ¸…ç†
   - ç›‘æ§é•¿æœŸè¿è¡Œçš„æœåŠ¡å†…å­˜ä½¿ç”¨æƒ…å†µ

3. **æ€§èƒ½é—®é¢˜**
   - åˆ†æCPUå’Œå†…å­˜ä½¿ç”¨ç‡
   - æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡
   - ä¼˜åŒ–ç½‘ç»œè¯·æ±‚é¢‘ç‡

### ç›‘æ§æŒ‡æ ‡

```typescript
// æœåŠ¡ç›‘æ§æŒ‡æ ‡æ”¶é›†
interface ServiceMetrics {
  uptime: number;
  memoryUsage: number;
  cpuUsage: number;
  activeConnections: number;
  requestRate: number;
  errorRate: number;
  responseTimePercentiles: {
    p50: number;
    p95: number;
    p99: number;
  };
}

// å¥åº·æ£€æŸ¥å®ç°
interface HealthCheck {
  healthy: boolean;
  message: string;
  timestamp: number;
  details?: any;
}
```

### è°ƒè¯•å·¥å…·

```typescript
// è°ƒè¯•è¾…åŠ©å·¥å…·
class ServiceDebugger {
  public static async dumpServiceState(service: any): Promise<any> {
    const state = {
      isRunning: service.isRunning,
      config: service.config,
      metrics: service.getMetrics(),
      health: await service.healthCheck()
    };

    console.log('æœåŠ¡çŠ¶æ€:', JSON.stringify(state, null, 2));
    return state;
  }

  public static async simulateError(service: any, errorType: string): Promise<void> {
    console.log(`æ¨¡æ‹Ÿ${errorType}é”™è¯¯`);
    // å®ç°é”™è¯¯æ¨¡æ‹Ÿé€»è¾‘
  }
}
```

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µå’Œæ¨¡å¼ï¼Œå¼€å‘è€…å¯ä»¥åˆ›å»ºå‡ºé«˜è´¨é‡ã€å¯ç»´æŠ¤çš„ä¸šåŠ¡æœåŠ¡ï¼Œæ”¯æŒç³»ç»Ÿçš„æŒç»­æ‰©å±•å’Œæ¼”è¿›ã€‚æ–°æœåŠ¡åº”è¯¥ä¸¥æ ¼éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥å®ç°æ¾è€¦åˆï¼Œå¹¶æä¾›å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç›‘æ§æœºåˆ¶ã€‚