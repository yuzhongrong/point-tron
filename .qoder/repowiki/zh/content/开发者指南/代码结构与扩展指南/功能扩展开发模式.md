# åŠŸèƒ½æ‰©å±•å¼€å‘æ¨¡å¼

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [src/index.ts](file://src/index.ts)
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts)
- [src/services/BlockDataService.ts](file://src/services/BlockDataService.ts)
- [src/services/AuthService.ts](file://src/services/AuthService.ts)
- [src/routes/blocks.ts](file://src/routes/blocks.ts)
- [src/routes/auth.ts](file://src/routes/auth.ts)
- [src/models/types.ts](file://src/models/types.ts)
- [src/models/BlockModel.ts](file://src/models/BlockModel.ts)
- [src/config/index.ts](file://src/config/index.ts)
- [src/database/index.ts](file://src/database/index.ts)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®æ¶æ„æ¦‚è§ˆ](#é¡¹ç›®æ¶æ„æ¦‚è§ˆ)
3. [MVCæ¶æ„æ‰©å±•åŸåˆ™](#mvcæ¶æ„æ‰©å±•åŸåˆ™)
4. [æ–°å¢åŠŸèƒ½å¼€å‘æµç¨‹](#æ–°å¢åŠŸèƒ½å¼€å‘æµç¨‹)
5. [äº¤æ˜“åˆ†æåŠŸèƒ½ç¤ºä¾‹](#äº¤æ˜“åˆ†æåŠŸèƒ½ç¤ºä¾‹)
6. [ä¾èµ–æ³¨å…¥ä¸æœåŠ¡é›†æˆ](#ä¾èµ–æ³¨å…¥ä¸æœåŠ¡é›†æˆ)
7. [æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹](#æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨Point-Troné¡¹ç›®ä¸­éµå¾ªMVCæ¶æ„æ¨¡å¼æ‰©å±•æ–°åŠŸèƒ½çš„æ ‡å‡†æµç¨‹ã€‚è¯¥é¡¹ç›®é‡‡ç”¨TypeScriptæ„å»ºï¼ŒåŸºäºExpressæ¡†æ¶ï¼Œå®ç°äº†TRONåŒºå—é“¾çš„åŒºå—æ•°æ®åˆ†æå’Œç®¡ç†ç³»ç»Ÿã€‚é€šè¿‡éµå¾ªæœ¬æ–‡æ¡£æä¾›çš„å¼€å‘æ¨¡å¼ï¼Œå¼€å‘è€…å¯ä»¥ç¡®ä¿æ–°åŠŸèƒ½ä¸ç°æœ‰ç³»ç»Ÿçš„æ— ç¼é›†æˆï¼Œå¹¶ä¿æŒä»£ç çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## é¡¹ç›®æ¶æ„æ¦‚è§ˆ

Point-Troné¡¹ç›®é‡‡ç”¨äº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

```mermaid
graph TB
subgraph "è¡¨ç°å±‚ (Presentation Layer)"
Routes[routes/]
WebUI[Webç•Œé¢]
end
subgraph "ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)"
Services[services/]
Controllers[æ§åˆ¶å™¨]
end
subgraph "æ•°æ®è®¿é—®å±‚ (Data Access Layer)"
Models[models/]
Database[æ•°æ®åº“]
end
subgraph "åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"
Config[config/]
Middleware[ä¸­é—´ä»¶]
Utils[å·¥å…·ç±»]
end
Routes --> Services
Services --> Models
Models --> Database
Services --> Controllers
Controllers --> WebUI
Config --> Services
Middleware --> Routes
```

**å›¾è¡¨æ¥æº**
- [src/index.ts](file://src/index.ts#L1-L163)
- [src/routes/blocks.ts](file://src/routes/blocks.ts#L1-L141)
- [src/services/BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L273)

**ç« èŠ‚æ¥æº**
- [src/index.ts](file://src/index.ts#L1-L163)
- [src/config/index.ts](file://src/config/index.ts#L1-L52)

## MVCæ¶æ„æ‰©å±•åŸåˆ™

### 1. åˆ†å±‚è®¾è®¡åŸåˆ™

Point-Tronä¸¥æ ¼éµå¾ªMVCï¼ˆModel-View-Controllerï¼‰æ¶æ„æ¨¡å¼ï¼Œæ¯ä¸€å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£åˆ†å·¥ï¼š

- **Modelå±‚**ï¼šè´Ÿè´£æ•°æ®ç»“æ„å®šä¹‰å’Œæ•°æ®åº“æ“ä½œ
- **Viewå±‚**ï¼šè´Ÿè´£ç”¨æˆ·ç•Œé¢å±•ç¤ºï¼ˆæœ¬é¡¹ç›®ä¸»è¦é€šè¿‡APIæä¾›æ•°æ®ï¼‰
- **Controllerå±‚**ï¼šè´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†å’Œè·¯ç”±æ§åˆ¶

### 2. ä¾èµ–æ³¨å…¥åŸåˆ™

é¡¹ç›®é‡‡ç”¨æ„é€ å‡½æ•°æ³¨å…¥çš„æ–¹å¼ç®¡ç†æœåŠ¡ä¾èµ–å…³ç³»ï¼Œç¡®ä¿æ¾è€¦åˆçš„è®¾è®¡ï¼š

```typescript
// åº”ç”¨ç±»ä¸­çš„ä¾èµ–æ³¨å…¥ç¤ºä¾‹
constructor() {
  this.app = express();
  this.tronRPCService = new TronRPCService();
  this.blockDataService = new BlockDataService(this.tronRPCService);
  
  this.initializeMiddlewares();
  this.initializeRoutes();
  this.initializeErrorHandling();
}
```

### 3. å¼‚æ­¥åˆå§‹åŒ–åŸåˆ™

æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦æŒ‰ç…§æ­£ç¡®çš„é¡ºåºè¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–ï¼Œç¡®ä¿ç³»ç»Ÿå¯åŠ¨çš„ç¨³å®šæ€§ï¼š

```typescript
public async start(): Promise<void> {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“
    await database.connect();
    await database.initializeTables();
    
    // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    await this.createDefaultAdmin();
    
    // å¯åŠ¨TRONåŒºå—æ•°æ®é‡‡é›†
    await this.blockDataService.start();
    
    // å¯åŠ¨ExpressæœåŠ¡å™¨
    this.app.listen(config.port, () => {
      console.log(`ğŸš€ Point-TronæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`);
    });
    
  } catch (error) {
    console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/index.ts](file://src/index.ts#L20-L163)

## æ–°å¢åŠŸèƒ½å¼€å‘æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè·¯ç”±æ¨¡å—

åœ¨`src/routes/`ç›®å½•ä¸‹åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶ï¼Œä¾‹å¦‚`transactions.ts`ï¼š

```typescript
import express from 'express';
import { TransactionModel } from '../models/TransactionModel';
import { TransactionService } from '../services/TransactionService';
import { ApiResponse } from '../models/types';
import { authenticateToken } from '../middleware/auth';

const router = express.Router();

// è·å–äº¤æ˜“ç»Ÿè®¡æ•°æ®
router.get('/stats', authenticateToken, async (req, res: express.Response<ApiResponse>) => {
  try {
    const stats = await TransactionService.getStats();
    res.json({
      success: true,
      data: stats
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

export default router;
```

### ç¬¬äºŒæ­¥ï¼šå®ç°ä¸šåŠ¡æœåŠ¡ç±»

åœ¨`src/services/`ç›®å½•ä¸‹åˆ›å»ºä¸šåŠ¡æœåŠ¡ç±»ï¼š

```typescript
import { TransactionModel } from '../models/TransactionModel';
import { TransactionStats } from '../models/types';

export class TransactionService {
  // è·å–äº¤æ˜“ç»Ÿè®¡ä¿¡æ¯
  static async getStats(): Promise<TransactionStats> {
    try {
      const [dailyStats, monthlyStats, yearlyStats] = await Promise.all([
        TransactionModel.getDailyStats(),
        TransactionModel.getMonthlyStats(),
        TransactionModel.getYearlyStats()
      ]);

      return {
        daily: dailyStats,
        monthly: monthlyStats,
        yearly: yearlyStats
      };
    } catch (error) {
      console.error('è·å–äº¤æ˜“ç»Ÿè®¡å¤±è´¥:', error);
      throw error;
    }
  }

  // åˆ†æäº¤æ˜“æ¨¡å¼
  static async analyzePatterns(): Promise<any> {
    // å®ç°äº¤æ˜“æ¨¡å¼åˆ†æé€»è¾‘
    return {};
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šå®šä¹‰æ•°æ®è®¿é—®æ¨¡å‹

åœ¨`src/models/`ç›®å½•ä¸‹åˆ›å»ºæ•°æ®è®¿é—®æ¨¡å‹ï¼š

```typescript
import { database } from '../database';
import { TransactionStats } from './types';

export class TransactionModel {
  // è·å–æ—¥äº¤æ˜“ç»Ÿè®¡
  static async getDailyStats(): Promise<any> {
    const today = new Date().toISOString().split('T')[0];
    const result = await database.get(
      `SELECT 
        COUNT(*) as total,
        SUM(amount) as volume,
        AVG(amount) as average
       FROM transactions 
       WHERE date(created_at) = ?`,
      [today]
    );

    return result || {};
  }

  // è·å–æœˆäº¤æ˜“ç»Ÿè®¡
  static async getMonthlyStats(): Promise<any> {
    const month = new Date().toISOString().split('-')[0] + '-' + new Date().toISOString().split('-')[1];
    const result = await database.get(
      `SELECT 
        COUNT(*) as total,
        SUM(amount) as volume,
        AVG(amount) as average
       FROM transactions 
       WHERE strftime('%Y-%m', created_at) = ?`,
      [month]
    );

    return result || {};
  }

  // è·å–å¹´äº¤æ˜“ç»Ÿè®¡
  static async getYearlyStats(): Promise<any> {
    const year = new Date().getFullYear().toString();
    const result = await database.get(
      `SELECT 
        COUNT(*) as total,
        SUM(amount) as volume,
        AVG(amount) as average
       FROM transactions 
       WHERE strftime('%Y', created_at) = ?`,
      [year]
    );

    return result || {};
  }
}
```

### ç¬¬å››æ­¥ï¼šæ›´æ–°ç±»å‹å®šä¹‰

åœ¨`src/models/types.ts`ä¸­æ·»åŠ æ–°çš„ç±»å‹å®šä¹‰ï¼š

```typescript
// äº¤æ˜“ç»Ÿè®¡æ¥å£
export interface TransactionStats {
  daily: {
    total: number;
    volume: number;
    average: number;
  };
  monthly: {
    total: number;
    volume: number;
    average: number;
  };
  yearly: {
    total: number;
    volume: number;
    average: number;
  };
}
```

**ç« èŠ‚æ¥æº**
- [src/routes/blocks.ts](file://src/routes/blocks.ts#L1-L141)
- [src/services/BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L273)
- [src/models/BlockModel.ts](file://src/models/BlockModel.ts#L1-L170)

## äº¤æ˜“åˆ†æåŠŸèƒ½ç¤ºä¾‹

è®©æˆ‘ä»¬ä»¥æ–°å¢"äº¤æ˜“åˆ†æ"åŠŸèƒ½ä¸ºä¾‹ï¼Œæ¼”ç¤ºä»è·¯ç”±å®šä¹‰åˆ°æœåŠ¡æ³¨å†Œçš„å®Œæ•´ä»£ç ç¤ºä¾‹ï¼š

### 1. è·¯ç”±å®šä¹‰ (src/routes/transactions.ts)

```typescript
import express from 'express';
import { TransactionModel } from '../models/TransactionModel';
import { TransactionService } from '../services/TransactionService';
import { ApiResponse } from '../models/types';
import { authenticateToken } from '../middleware/auth';

const router = express.Router();

// è·å–äº¤æ˜“ç»Ÿè®¡æ•°æ®
router.get('/stats', authenticateToken, async (req, res: express.Response<ApiResponse>) => {
  try {
    const stats = await TransactionService.getStats();
    res.json({
      success: true,
      data: stats
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–äº¤æ˜“æ¨¡å¼åˆ†æ
router.get('/patterns', authenticateToken, async (req, res: express.Response<ApiResponse>) => {
  try {
    const patterns = await TransactionService.analyzePatterns();
    res.json({
      success: true,
      data: patterns
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

export default router;
```

### 2. ä¸šåŠ¡æœåŠ¡ç±» (src/services/TransactionService.ts)

```typescript
import { TransactionModel } from '../models/TransactionModel';
import { TransactionStats } from '../models/types';

export class TransactionService {
  // è·å–äº¤æ˜“ç»Ÿè®¡ä¿¡æ¯
  static async getStats(): Promise<TransactionStats> {
    try {
      const [dailyStats, monthlyStats, yearlyStats] = await Promise.all([
        TransactionModel.getDailyStats(),
        TransactionModel.getMonthlyStats(),
        TransactionModel.getYearlyStats()
      ]);

      return {
        daily: dailyStats,
        monthly: monthlyStats,
        yearly: yearlyStats
      };
    } catch (error) {
      console.error('è·å–äº¤æ˜“ç»Ÿè®¡å¤±è´¥:', error);
      throw error;
    }
  }

  // åˆ†æäº¤æ˜“æ¨¡å¼
  static async analyzePatterns(): Promise<any> {
    try {
      // è·å–æœ€è¿‘1000ç¬”äº¤æ˜“
      const recentTransactions = await TransactionModel.getRecentTransactions(1000);
      
      // è®¡ç®—äº¤æ˜“é¢‘ç‡åˆ†å¸ƒ
      const frequencyDistribution = this.calculateFrequencyDistribution(recentTransactions);
      
      // åˆ†æé‡‘é¢åˆ†å¸ƒ
      const amountDistribution = this.calculateAmountDistribution(recentTransactions);
      
      // æ£€æµ‹å¼‚å¸¸äº¤æ˜“
      const anomalies = this.detectAnomalies(recentTransactions);
      
      return {
        frequencyDistribution,
        amountDistribution,
        anomalies,
        timestamp: Date.now()
      };
    } catch (error) {
      console.error('äº¤æ˜“æ¨¡å¼åˆ†æå¤±è´¥:', error);
      throw error;
    }
  }

  private static calculateFrequencyDistribution(transactions: any[]): any {
    // å®ç°é¢‘ç‡åˆ†å¸ƒè®¡ç®—é€»è¾‘
    return {};
  }

  private static calculateAmountDistribution(transactions: any[]): any {
    // å®ç°é‡‘é¢åˆ†å¸ƒè®¡ç®—é€»è¾‘
    return {};
  }

  private static detectAnomalies(transactions: any[]): any[] {
    // å®ç°å¼‚å¸¸æ£€æµ‹é€»è¾‘
    return [];
  }
}
```

### 3. æ•°æ®è®¿é—®æ¨¡å‹ (src/models/TransactionModel.ts)

```typescript
import { database } from '../database';
import { TransactionStats } from './types';

export class TransactionModel {
  // è·å–æ—¥äº¤æ˜“ç»Ÿè®¡
  static async getDailyStats(): Promise<any> {
    const today = new Date().toISOString().split('T')[0];
    const result = await database.get(
      `SELECT 
        COUNT(*) as total,
        SUM(amount) as volume,
        AVG(amount) as average,
        MAX(amount) as max,
        MIN(amount) as min
       FROM transactions 
       WHERE date(created_at) = ?`,
      [today]
    );

    return result || {};
  }

  // è·å–æœˆäº¤æ˜“ç»Ÿè®¡
  static async getMonthlyStats(): Promise<any> {
    const month = new Date().toISOString().split('-')[0] + '-' + new Date().toISOString().split('-')[1];
    const result = await database.get(
      `SELECT 
        COUNT(*) as total,
        SUM(amount) as volume,
        AVG(amount) as average,
        MAX(amount) as max,
        MIN(amount) as min
       FROM transactions 
       WHERE strftime('%Y-%m', created_at) = ?`,
      [month]
    );

    return result || {};
  }

  // è·å–å¹´äº¤æ˜“ç»Ÿè®¡
  static async getYearlyStats(): Promise<any> {
    const year = new Date().getFullYear().toString();
    const result = await database.get(
      `SELECT 
        COUNT(*) as total,
        SUM(amount) as volume,
        AVG(amount) as average,
        MAX(amount) as max,
        MIN(amount) as min
       FROM transactions 
       WHERE strftime('%Y', created_at) = ?`,
      [year]
    );

    return result || {};
  }

  // è·å–æœ€è¿‘äº¤æ˜“è®°å½•
  static async getRecentTransactions(limit: number = 100): Promise<any[]> {
    const results = await database.all(
      `SELECT * FROM transactions 
       ORDER BY created_at DESC 
       LIMIT ?`,
      [limit]
    );

    return results;
  }
}
```

### 4. ç±»å‹å®šä¹‰æ›´æ–° (src/models/types.ts)

```typescript
// äº¤æ˜“ç»Ÿè®¡æ¥å£
export interface TransactionStats {
  daily: {
    total: number;
    volume: number;
    average: number;
    max: number;
    min: number;
  };
  monthly: {
    total: number;
    volume: number;
    average: number;
    max: number;
    min: number;
  };
  yearly: {
    total: number;
    volume: number;
    average: number;
    max: number;
    min: number;
  };
}

// äº¤æ˜“æ¥å£
export interface Transaction {
  id?: number;
  tx_hash: string;
  from_address: string;
  to_address: string;
  amount: number;
  fee: number;
  timestamp: number;
  created_at?: string;
}
```

### 5. æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- æ·»åŠ äº¤æ˜“è¡¨
CREATE TABLE IF NOT EXISTS transactions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  tx_hash VARCHAR(66) UNIQUE NOT NULL,
  from_address VARCHAR(64) NOT NULL,
  to_address VARCHAR(64) NOT NULL,
  amount DECIMAL(20, 8) NOT NULL,
  fee DECIMAL(20, 8) NOT NULL,
  timestamp BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_transactions_hash ON transactions(tx_hash);
CREATE INDEX IF NOT EXISTS idx_transactions_from ON transactions(from_address);
CREATE INDEX IF NOT EXISTS idx_transactions_to ON transactions(to_address);
CREATE INDEX IF NOT EXISTS idx_transactions_timestamp ON transactions(timestamp);
```

**ç« èŠ‚æ¥æº**
- [src/routes/blocks.ts](file://src/routes/blocks.ts#L1-L141)
- [src/services/BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L273)
- [src/models/BlockModel.ts](file://src/models/BlockModel.ts#L1-L170)

## ä¾èµ–æ³¨å…¥ä¸æœåŠ¡é›†æˆ

### åœ¨Appç±»ä¸­é›†æˆæ–°æœåŠ¡

åœ¨`src/index.ts`ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é›†æˆæ–°çš„äº¤æ˜“åˆ†ææœåŠ¡ï¼š

#### 1. å¯¼å…¥æ–°æœåŠ¡

```typescript
import { TransactionService } from './services/TransactionService';
```

#### 2. å£°æ˜ç§æœ‰å±æ€§

```typescript
class App {
  public app: express.Application;
  private tronRPCService: TronRPCService;
  private blockDataService: BlockDataService;
  private transactionService: TransactionService; // æ–°å¢æœåŠ¡å±æ€§
```

#### 3. æ„é€ å‡½æ•°å®ä¾‹åŒ–

```typescript
constructor() {
  this.app = express();
  this.tronRPCService = new TronRPCService();
  this.blockDataService = new BlockDataService(this.tronRPCService);
  this.transactionService = new TransactionService(); // å®ä¾‹åŒ–æ–°æœåŠ¡
  
  this.initializeMiddlewares();
  this.initializeRoutes();
  this.initializeErrorHandling();
}
```

#### 4. åœ¨startæ–¹æ³•ä¸­å¯åŠ¨æœåŠ¡

```typescript
public async start(): Promise<void> {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“
    await database.connect();
    await database.initializeTables();
    
    // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    await this.createDefaultAdmin();
    
    // å¯åŠ¨TRONåŒºå—æ•°æ®é‡‡é›†
    await this.blockDataService.start();
    
    // å¯åŠ¨äº¤æ˜“åˆ†ææœåŠ¡
    await this.transactionService.start(); // å¦‚æœéœ€è¦å¼‚æ­¥åˆå§‹åŒ–
    
    // å¯åŠ¨ExpressæœåŠ¡å™¨
    this.app.listen(config.port, () => {
      console.log(`ğŸš€ Point-TronæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`);
      console.log(`ğŸ“¡ æœåŠ¡åœ°å€: http://localhost:${config.port}`);
      console.log(`ğŸ”— TRONç½‘ç»œ: ${config.tron.rpcUrl}`);
      console.log(`â° è½®è¯¢é—´éš”: ${config.tron.pollingInterval}ms`);
      console.log(`ğŸ“Š åå°ç®¡ç†: http://localhost:${config.port}/admin`);
    });
    
  } catch (error) {
    console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}
```

### æœåŠ¡å¯åŠ¨æ¨¡å¼

æ ¹æ®æœåŠ¡çš„ä¸åŒç‰¹æ€§ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„å¯åŠ¨æ¨¡å¼ï¼š

#### å¼‚æ­¥åˆå§‹åŒ–æœåŠ¡

å¯¹äºéœ€è¦å¼‚æ­¥åˆå§‹åŒ–çš„æœåŠ¡ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€è¿œç¨‹APIè°ƒç”¨ç­‰ï¼‰ï¼š

```typescript
// åœ¨æœåŠ¡ç±»ä¸­æ·»åŠ startæ–¹æ³•
export class TransactionService {
  private isRunning: boolean = false;
  
  public async start(): Promise<void> {
    if (this.isRunning) {
      console.warn('äº¤æ˜“åˆ†ææœåŠ¡å·²åœ¨è¿è¡Œä¸­');
      return;
    }
    
    try {
      // æ‰§è¡Œå¼‚æ­¥åˆå§‹åŒ–é€»è¾‘
      await this.initializeResources();
      
      this.isRunning = true;
      console.log('âœ… äº¤æ˜“åˆ†ææœåŠ¡å·²å¯åŠ¨');
    } catch (error) {
      console.error('å¯åŠ¨äº¤æ˜“åˆ†ææœåŠ¡å¤±è´¥:', error);
      throw error;
    }
  }
  
  private async initializeResources(): Promise<void> {
    // å®ç°èµ„æºåˆå§‹åŒ–é€»è¾‘
  }
}
```

#### åå°ä»»åŠ¡æœåŠ¡

å¯¹äºéœ€è¦æŒç»­è¿è¡Œçš„åå°ä»»åŠ¡æœåŠ¡ï¼š

```typescript
export class TransactionService {
  private pollingTimer: NodeJS.Timeout | null = null;
  
  public startPolling(): void {
    if (this.pollingTimer) {
      console.warn('äº¤æ˜“åˆ†æè½®è¯¢å·²åœ¨è¿è¡Œä¸­');
      return;
    }
    
    console.log('å¼€å§‹äº¤æ˜“åˆ†æè½®è¯¢');
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    this.executePolling();
    
    // è®¾ç½®å®šæ—¶å™¨
    this.pollingTimer = setInterval(() => {
      this.executePolling();
    }, config.transaction.pollingInterval);
  }
  
  private async executePolling(): Promise<void> {
    try {
      // æ‰§è¡Œè½®è¯¢é€»è¾‘
      await this.analyzeTransactions();
    } catch (error) {
      console.error('äº¤æ˜“åˆ†æè½®è¯¢é”™è¯¯:', error);
    }
  }
  
  public stopPolling(): void {
    if (this.pollingTimer) {
      clearInterval(this.pollingTimer);
      this.pollingTimer = null;
    }
    console.log('äº¤æ˜“åˆ†æè½®è¯¢å·²åœæ­¢');
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/index.ts](file://src/index.ts#L20-L163)
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L1-L258)

## æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹

### 1. ç±»å‹å¯¼å…¥è·¯å¾„

ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç›¸å¯¹è·¯å¾„å¯¼å…¥ç±»å‹ï¼š

```typescript
// æ­£ç¡®çš„å¯¼å…¥æ–¹å¼
import { Transaction } from '../models/types';
import { ApiResponse } from '../models/types';

// é”™è¯¯çš„å¯¼å…¥æ–¹å¼
import { Transaction } from '../../models/types'; // ä¸è¦ä½¿ç”¨è¿‡å¤šçš„../
```

### 2. å¼‚æ­¥åˆå§‹åŒ–é¡ºåº

ä¸¥æ ¼æŒ‰ç…§ä¾èµ–å…³ç³»è¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–ï¼š

```typescript
// æ­£ç¡®çš„åˆå§‹åŒ–é¡ºåº
public async start(): Promise<void> {
  try {
    // 1. è¿æ¥æ•°æ®åº“
    await database.connect();
    
    // 2. åˆå§‹åŒ–æ•°æ®åº“è¡¨
    await database.initializeTables();
    
    // 3. åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    await this.createDefaultAdmin();
    
    // 4. å¯åŠ¨ä¾èµ–çš„æœåŠ¡
    await this.blockDataService.start();
    
    // 5. å¯åŠ¨å½“å‰æœåŠ¡
    await this.transactionService.start();
    
    // 6. å¯åŠ¨ä¸»æœåŠ¡å™¨
    this.app.listen(config.port, () => {
      console.log('æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ');
    });
    
  } catch (error) {
    console.error('å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}
```

### 3. é”™è¯¯è¾¹ç•Œå¤„ç†

åœ¨æ¯ä¸ªå±‚çº§éƒ½è¦å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†ï¼š

```typescript
// è·¯ç”±å±‚é”™è¯¯å¤„ç†
router.get('/stats', authenticateToken, async (req, res: express.Response<ApiResponse>) => {
  try {
    const stats = await TransactionService.getStats();
    res.json({
      success: true,
      data: stats
    });
  } catch (error) {
    console.error('è·å–äº¤æ˜“ç»Ÿè®¡é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æœåŠ¡å±‚é”™è¯¯å¤„ç†
static async getStats(): Promise<TransactionStats> {
  try {
    const [dailyStats, monthlyStats, yearlyStats] = await Promise.all([
      TransactionModel.getDailyStats(),
      TransactionModel.getMonthlyStats(),
      TransactionModel.getYearlyStats()
    ]);

    return {
      daily: dailyStats,
      monthly: monthlyStats,
      yearly: yearlyStats
    };
  } catch (error) {
    console.error('è·å–äº¤æ˜“ç»Ÿè®¡å¤±è´¥:', error);
    throw new Error('æ— æ³•è·å–äº¤æ˜“ç»Ÿè®¡ä¿¡æ¯');
  }
}
```

### 4. èµ„æºæ¸…ç†

å®ç°é€‚å½“çš„èµ„æºæ¸…ç†æœºåˆ¶ï¼š

```typescript
public async shutdown(): Promise<void> {
  console.log('æ­£åœ¨å…³é—­åº”ç”¨...');
  
  // åœæ­¢TRONæ•°æ®é‡‡é›†
  this.blockDataService.stop();
  
  // åœæ­¢äº¤æ˜“åˆ†ææœåŠ¡
  this.transactionService.stop();
  
  // å…³é—­æ•°æ®åº“è¿æ¥
  await database.close();
  
  console.log('åº”ç”¨å·²å®‰å…¨å…³é—­');
  process.exit(0);
}
```

### 5. æ—¥å¿—è®°å½•

åœ¨å…³é”®æ“ä½œç‚¹æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼š

```typescript
// åœ¨æœåŠ¡å¯åŠ¨æ—¶è®°å½•è¯¦ç»†ä¿¡æ¯
console.log(`å¼€å§‹TRON RPCè½®è¯¢ï¼Œé—´éš”: ${this.pollingInterval}ms`);

// åœ¨å…³é”®ä¸šåŠ¡æ“ä½œæ—¶è®°å½•çŠ¶æ€
console.log(`ğŸ“¦ å¤„ç†æ–°åŒºå—: ${blockInfo.block_number}, å“ˆå¸Œæœ«ä½æ•°å­—: ${blockInfo.last_digit} (${blockInfo.is_odd ? 'å•' : 'åŒ'}æ•°)`);

// åœ¨é”™è¯¯å‘ç”Ÿæ—¶è®°å½•è¯¦ç»†ä¿¡æ¯
console.error(`å¤„ç†åŒºå— ${blockInfo.block_number} å¤±è´¥:`, error);
```

### 6. é…ç½®ç®¡ç†

ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç®¡ç†æ–¹å¼ï¼š

```typescript
// åœ¨config/index.tsä¸­æ·»åŠ æ–°é…ç½®
interface Config {
  // ... ç°æœ‰é…ç½®
  transaction: {
    pollingInterval: number;
    batchSize: number;
    maxRetries: number;
  };
}

const config: Config = {
  // ... ç°æœ‰é…ç½®
  transaction: {
    pollingInterval: parseInt(process.env.TRANSACTION_POLLING_INTERVAL || '60000', 10),
    batchSize: parseInt(process.env.TRANSACTION_BATCH_SIZE || '100', 10),
    maxRetries: parseInt(process.env.TRANSACTION_MAX_RETRIES || '3', 10),
  },
};
```

**ç« èŠ‚æ¥æº**
- [src/index.ts](file://src/index.ts#L120-L163)
- [src/config/index.ts](file://src/config/index.ts#L1-L52)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

**é—®é¢˜æè¿°**ï¼šæ–°æ·»åŠ çš„æœåŠ¡æ— æ³•æ­£å¸¸å¯åŠ¨

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æœåŠ¡ç±»çš„æ„é€ å‡½æ•°æ˜¯å¦æœ‰å‚æ•°ä¾èµ–
2. ç¡®è®¤ä¾èµ–çš„æœåŠ¡æ˜¯å¦å·²ç»æ­£ç¡®åˆå§‹åŒ–
3. æŸ¥çœ‹æœåŠ¡çš„start()æ–¹æ³•å®ç°
4. æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ç¡®ä¿åœ¨Appç±»ä¸­æ­£ç¡®åˆå§‹åŒ–æœåŠ¡
constructor() {
  // ... å…¶ä»–åˆå§‹åŒ–
  
  // ç¡®ä¿ä¾èµ–çš„æœåŠ¡å·²ç»åˆå§‹åŒ–
  if (!this.blockDataService) {
    throw new Error('BlockDataServiceæœªåˆå§‹åŒ–');
  }
  
  this.transactionService = new TransactionService(this.blockDataService);
}
```

#### 2. è·¯ç”±æ— æ³•è®¿é—®

**é—®é¢˜æè¿°**ï¼šæ–°æ·»åŠ çš„è·¯ç”±æ— æ³•è¢«è®¿é—®

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥è·¯ç”±æ–‡ä»¶æ˜¯å¦æ­£ç¡®å¯¼å‡ºdefault
2. ç¡®è®¤åœ¨index.tsä¸­æ­£ç¡®å¯¼å…¥è·¯ç”±
3. æ£€æŸ¥è·¯ç”±å‰ç¼€æ˜¯å¦æ­£ç¡®
4. ç¡®è®¤ä¸­é—´ä»¶è®¤è¯æ˜¯å¦æ­£å¸¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ç¡®ä¿è·¯ç”±æ–‡ä»¶æ­£ç¡®å¯¼å‡º
export default router;

// ç¡®ä¿åœ¨index.tsä¸­æ­£ç¡®å¯¼å…¥
import transactionRoutes from './routes/transactions';

// ç¡®ä¿åœ¨initializeRoutesä¸­æ­£ç¡®æ³¨å†Œ
this.app.use('/api/transactions', transactionRoutes);
```

#### 3. æ•°æ®åº“è¡¨ä¸å­˜åœ¨

**é—®é¢˜æè¿°**ï¼šæœåŠ¡è®¿é—®æ•°æ®åº“æ—¶æŠ¥é”™ï¼Œæç¤ºè¡¨ä¸å­˜åœ¨

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
2. ç¡®è®¤è¡¨åæ‹¼å†™æ­£ç¡®
3. æ£€æŸ¥ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º
4. ç¡®è®¤æ•°æ®åº“è¿æ¥çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨database/index.tsä¸­æ·»åŠ è¡¨åˆå§‹åŒ–
await this.run(`
  CREATE TABLE IF NOT EXISTS transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tx_hash VARCHAR(66) UNIQUE NOT NULL,
    from_address VARCHAR(64) NOT NULL,
    to_address VARCHAR(64) NOT NULL,
    amount DECIMAL(20, 8) NOT NULL,
    fee DECIMAL(20, 8) NOT NULL,
    timestamp BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  )
`);
```

#### 4. å†…å­˜æ³„æ¼

**é—®é¢˜æè¿°**ï¼šé•¿æ—¶é—´è¿è¡Œåå†…å­˜å ç”¨æŒç»­å¢é•¿

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥å®šæ—¶å™¨æ˜¯å¦æ­£ç¡®æ¸…ç†
2. ç¡®è®¤äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®ç§»é™¤
3. æ£€æŸ¥å¾ªç¯å¼•ç”¨
4. ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨æœåŠ¡ç±»ä¸­æ·»åŠ æ¸…ç†æ–¹æ³•
public stop(): void {
  if (this.pollingTimer) {
    clearInterval(this.pollingTimer);
    this.pollingTimer = null;
  }
  
  // æ¸…ç†å…¶ä»–èµ„æº
  this.clearEventListeners();
  this.releaseMemory();
}
```

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

```typescript
// åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨è¯¦ç»†æ—¥å¿—
if (process.env.NODE_ENV === 'development') {
  console.log('è¯¦ç»†è°ƒè¯•ä¿¡æ¯:', {
    serviceStatus: this.getStatus(),
    memoryUsage: process.memoryUsage(),
    uptime: process.uptime()
  });
}
```

#### 2. ä½¿ç”¨æ–­ç‚¹è°ƒè¯•

```typescript
// åœ¨å…³é”®ä½ç½®æ·»åŠ æ–­ç‚¹
public async start(): Promise<void> {
  debugger; // æ·»åŠ æ–­ç‚¹
  try {
    // ... ä¸šåŠ¡é€»è¾‘
  } catch (error) {
    debugger; // æ·»åŠ é”™è¯¯æ–­ç‚¹
    throw error;
  }
}
```

#### 3. æ€§èƒ½ç›‘æ§

```typescript
// æ·»åŠ æ€§èƒ½ç›‘æ§
const startTime = Date.now();
try {
  const result = await this.performOperation();
  const endTime = Date.now();
  console.log(`æ“ä½œè€—æ—¶: ${endTime - startTime}ms`);
  return result;
} catch (error) {
  console.error(`æ“ä½œå¤±è´¥ï¼Œè€—æ—¶: ${Date.now() - startTime}ms`);
  throw error;
}
```

**ç« èŠ‚æ¥æº**
- [src/index.ts](file://src/index.ts#L120-L163)
- [src/database/index.ts](file://src/database/index.ts#L1-L249)

## æ€»ç»“

é€šè¿‡æœ¬æ–‡æ¡£ä»‹ç»çš„åŠŸèƒ½æ‰©å±•å¼€å‘æ¨¡å¼ï¼Œå¼€å‘è€…å¯ä»¥ï¼š

1. **éµå¾ªMVCæ¶æ„**ï¼šä¸¥æ ¼æŒ‰ç…§Model-View-Controlleråˆ†å±‚è®¾è®¡åŸåˆ™
2. **å®ç°ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ç®¡ç†æœåŠ¡ä¾èµ–å…³ç³»
3. **ä¿è¯å¼‚æ­¥åˆå§‹åŒ–é¡ºåº**ï¼šæŒ‰ç…§æ­£ç¡®çš„ä¾èµ–å…³ç³»è¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–
4. **å®ç°é”™è¯¯è¾¹ç•Œå¤„ç†**ï¼šåœ¨æ¯ä¸ªå±‚çº§éƒ½å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†æœºåˆ¶
5. **ç¡®ä¿èµ„æºæ¸…ç†**ï¼šå®ç°é€‚å½“çš„èµ„æºæ¸…ç†å’Œä¼˜é›…å…³é—­æœºåˆ¶

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œæ–°åŠŸèƒ½èƒ½å¤Ÿä¸Point-Tronçš„æ ¸å¿ƒç³»ç»Ÿæ— ç¼é›†æˆï¼Œä¿æŒä»£ç çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚åŒæ—¶ï¼Œå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æœºåˆ¶ç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯è°ƒè¯•æ€§ã€‚

åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå»ºè®®å¼€å‘è€…å§‹ç»ˆå‚è€ƒé¡¹ç›®ç°æœ‰çš„ä»£ç é£æ ¼å’Œæ¶æ„æ¨¡å¼ï¼Œç¡®ä¿æ–°åŠŸèƒ½ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚å®šæœŸè¿›è¡Œä»£ç å®¡æŸ¥å’Œæ€§èƒ½æµ‹è¯•ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³æ½œåœ¨çš„é—®é¢˜ã€‚