# TypeScriptç¼–ç è§„èŒƒä¸æœ€ä½³å®è·µ

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [tsconfig.json](file://tsconfig.json)
- [package.json](file://package.json)
- [src/index.ts](file://src/index.ts)
- [src/models/types.ts](file://src/models/types.ts)
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts)
- [src/middleware/auth.ts](file://src/middleware/auth.ts)
- [src/services/AuthService.ts](file://src/services/AuthService.ts)
- [src/models/UserModel.ts](file://src/models/UserModel.ts)
- [src/routes/auth.ts](file://src/routes/auth.ts)
- [src/routes/blocks.ts](file://src/routes/blocks.ts)
- [src/config/index.ts](file://src/config/index.ts)
- [test.js](file://test.js)
</cite>

## ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [TypeScripté…ç½®è§„èŒƒ](#typescripté…ç½®è§„èŒƒ)
3. [å‘½åçº¦å®š](#å‘½åçº¦å®š)
4. [ä»£ç æ ¼å¼åŒ–ä¸ç±»å‹å®šä¹‰](#ä»£ç æ ¼å¼åŒ–ä¸ç±»å‹å®šä¹‰)
5. [é”™è¯¯å¤„ç†æœ€ä½³å®è·µ](#é”™è¯¯å¤„ç†æœ€ä½³å®è·µ)
6. [å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ](#å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ)
7. [æ—¥å¿—è®°å½•ç­–ç•¥](#æ—¥å¿—è®°å½•ç­–ç•¥)
8. [å•å…ƒæµ‹è¯•åŸåˆ™](#å•å…ƒæµ‹è¯•åŸåˆ™)
9. [ä»£ç å®¡æŸ¥æ¸…å•](#ä»£ç å®¡æŸ¥æ¸…å•)
10. [JSDocæ³¨é‡Šè§„èŒƒ](#jsdocæ³¨é‡Šè§„èŒƒ)
11. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
12. [æ€»ç»“](#æ€»ç»“)

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºTypeScriptçš„TRONæ³¢åœºç½‘ç»œåŒºå—é“¾æ•°æ®ç»Ÿè®¡åå°ç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„TypeScriptå¼€å‘è§„èŒƒï¼Œæ³¨é‡ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚é¡¹ç›®ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–ç¨‹åº¦é«˜ï¼Œæ¶µç›–äº†å®Œæ•´çš„åç«¯å¼€å‘æœ€ä½³å®è·µã€‚

## TypeScripté…ç½®è§„èŒƒ

### ä¸¥æ ¼æ¨¡å¼é…ç½®

é¡¹ç›®åœ¨`tsconfig.json`ä¸­å¯ç”¨äº†ä¸¥æ ¼çš„TypeScriptç¼–è¯‘é€‰é¡¹ï¼š

```json
{
  "compilerOptions": {
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  }
}
```

**ä¸¥æ ¼æ¨¡å¼çš„é‡è¦æ€§ï¼š**
- **ç±»å‹æ£€æŸ¥å¢å¼º**ï¼šå¯ç”¨æ‰€æœ‰ä¸¥æ ¼ç±»å‹æ£€æŸ¥é€‰é¡¹
- **æ¨¡å—äº’æ“ä½œ**ï¼šæ”¯æŒCommonJSå’ŒESæ¨¡å—çš„äº’æ“ä½œ
- **è·³è¿‡åº“æ£€æŸ¥**ï¼šæé«˜ç¼–è¯‘é€Ÿåº¦ï¼Œé¿å…ç¬¬ä¸‰æ–¹åº“çš„ç±»å‹æ£€æŸ¥é—®é¢˜

### ç¼–è¯‘ç›®æ ‡é…ç½®

```json
{
  "compilerOptions": {
    "target": "es6",
    "module": "commonjs",
    "moduleResolution": "node"
  }
}
```

**é…ç½®è¯´æ˜ï¼š**
- ä½¿ç”¨ES6ä½œä¸ºç›®æ ‡ç‰ˆæœ¬ï¼Œæ”¯æŒç°ä»£JavaScriptç‰¹æ€§
- é‡‡ç”¨CommonJSæ¨¡å—ç³»ç»Ÿï¼Œå…¼å®¹Node.jsç¯å¢ƒ
- å¯ç”¨Node.jsæ¨¡å—è§£æç­–ç•¥ï¼Œæ”¯æŒnpmåŒ…è§£æ

**ç« èŠ‚æ¥æº**
- [tsconfig.json](file://tsconfig.json#L1-L14)

## å‘½åçº¦å®š

### å˜é‡å‘½åè§„èŒƒ

é¡¹ç›®ä¸¥æ ¼éµå¾ªé©¼å³°å¼å‘½åæ³•ï¼š

```typescript
// âœ… æ¨èï¼šå˜é‡ä½¿ç”¨é©¼å³°å¼å‘½å
const userName = 'admin';
const blockNumber = 123456;
const pollingInterval = 3000;

// âŒ ä¸æ¨èï¼šä½¿ç”¨ä¸‹åˆ’çº¿æˆ–å¤§å†™å­—æ¯å¼€å¤´
const _userName = 'admin'; // ä¸‹åˆ’çº¿å‰ç¼€
const UserName = 'admin';  // PascalCaseç”¨äºç±»å
```

### ç±»åå‘½åè§„èŒƒ

é¡¹ç›®ä½¿ç”¨å¸•æ–¯å¡å¼ï¼ˆPascalCaseï¼‰å‘½åç±»ï¼š

```typescript
// âœ… æ¨èï¼šç±»åä½¿ç”¨å¸•æ–¯å¡å¼å‘½å
class TronRPCService {
  // ç±»å®ç°
}

class AuthService {
  // ç±»å®ç°
}

// âœ… æ¨èï¼šæ¥å£ä½¿ç”¨å¸•æ–¯å¡å¼å‘½å
interface BlockInfo {
  id?: number;
  block_number: number;
  block_hash: string;
  timestamp: number;
}

// âœ… æ¨èï¼šæšä¸¾ä½¿ç”¨å¸•æ–¯å¡å¼å‘½å
enum TimeRange {
  OneDay = '1day',
  OneWeek = '1week',
  OneMonth = '1month'
}
```

### å‡½æ•°å’Œæ–¹æ³•å‘½å

```typescript
// âœ… æ¨èï¼šå‡½æ•°ä½¿ç”¨åŠ¨è¯å¼€å¤´çš„é©¼å³°å¼å‘½å
async function getLatestBlock(): Promise<BlockInfo> {
  // å®ç°
}

function parseBlockHash(hash: string): number {
  // å®ç°
}

// âœ… æ¨èï¼šç§æœ‰æ–¹æ³•ä»¥ä¸‹åˆ’çº¿å¼€å¤´
private async _executePolling(): Promise<void> {
  // å®ç°
}
```

**ç« èŠ‚æ¥æº**
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L1-L50)
- [src/models/types.ts](file://src/models/types.ts#L1-L60)

## ä»£ç æ ¼å¼åŒ–ä¸ç±»å‹å®šä¹‰

### æ¥å£ä¸ç±»å‹å®šä¹‰

é¡¹ç›®å¹¿æ³›ä½¿ç”¨TypeScriptæ¥å£å’Œç±»å‹åˆ«åæ¥ç¡®ä¿ç±»å‹å®‰å…¨ï¼š

```typescript
// âœ… æ¨èï¼šä½¿ç”¨æ¥å£å®šä¹‰å¤æ‚çš„æ•°æ®ç»“æ„
export interface BlockInfo {
  id?: number;
  block_number: number;
  block_hash: string;
  timestamp: number;
  last_digit: number;
  is_odd: boolean;
  created_at?: string;
}

// âœ… æ¨èï¼šä½¿ç”¨ç±»å‹åˆ«åç®€åŒ–å¤æ‚ç±»å‹
export type ApiResponse<T = any> = {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
};

// âœ… æ¨èï¼šä½¿ç”¨æ³›å‹å¢å¼ºç±»å‹çµæ´»æ€§
export async function create<T>(model: T): Promise<number> {
  // å®ç°
}
```

### é¿å…ä½¿ç”¨anyç±»å‹

é¡¹ç›®ä¸¥æ ¼é¿å…ä½¿ç”¨`any`ç±»å‹ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ï¼š

```typescript
// âœ… æ¨èï¼šæ˜ç¡®æŒ‡å®šç±»å‹
async function getUserById(id: number): Promise<User | null> {
  const result = await database.get('SELECT * FROM users WHERE id = ?', [id]);
  return result || null;
}

// âœ… æ¨èï¼šä½¿ç”¨è”åˆç±»å‹å¤„ç†å¤šç§å¯èƒ½æ€§
function parseResponse(response: any): BlockInfo | null {
  try {
    // è§£æé€»è¾‘
    return parsedData;
  } catch (error) {
    console.error('è§£æå¤±è´¥:', error);
    return null;
  }
}

// âœ… æ¨èï¼šä½¿ç”¨ç±»å‹æ–­è¨€è€Œéany
const decoded = jwt.verify(token, secret) as JWTPayload;
```

### ç±»å‹å®ˆå«ä¸ç±»å‹ä¿æŠ¤

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ç±»å‹å®ˆå«ç¡®ä¿ç±»å‹å®‰å…¨
function isBlockInfo(obj: any): obj is BlockInfo {
  return obj &&
         typeof obj.block_number === 'number' &&
         typeof obj.block_hash === 'string';
}

// âœ… æ¨èï¼šä½¿ç”¨ç±»å‹ä¿æŠ¤å¤„ç†è”åˆç±»å‹
function handleApiResponse(response: ApiResponse): void {
  if (response.success) {
    // åœ¨è¿™é‡Œï¼ŒTypeScriptçŸ¥é“response.dataå­˜åœ¨
    console.log('æ•°æ®:', response.data);
  } else {
    // åœ¨è¿™é‡Œï¼ŒTypeScriptçŸ¥é“response.errorå­˜åœ¨
    console.error('é”™è¯¯:', response.error);
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/models/types.ts](file://src/models/types.ts#L1-L60)
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L100-L150)

## é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### try-catchä½¿ç”¨è§„èŒƒ

é¡¹ç›®é‡‡ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥ï¼š

```typescript
// âœ… æ¨èï¼šåœ¨å…³é”®ä¸šåŠ¡é€»è¾‘ä¸­ä½¿ç”¨try-catch
public async getLatestBlock(): Promise<BlockInfo> {
  try {
    const response = await this.makeHttpRequest('/wallet/getnowblock', {});
    return this.parseTronBlockResponse(response);
  } catch (error: any) {
    console.error('è·å–æœ€æ–°åŒºå—å¤±è´¥:', error?.message);
    throw new Error(`RPCè¯·æ±‚å¤±è´¥: ${error?.message}`);
  }
}

// âœ… æ¨èï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­æ•è·å¼‚å¸¸
private async executePolling(): Promise<void> {
  try {
    const latestBlock = await this.getLatestBlock();
    
    if (this.onBlockCallback) {
      this.onBlockCallback(latestBlock);
    }
    
    this.consecutiveErrors = 0;
    this.lastBlockTime = Date.now();

  } catch (error: any) {
    this.consecutiveErrors++;
    console.error(`RPCè½®è¯¢é”™è¯¯ (è¿ç»­ç¬¬${this.consecutiveErrors}æ¬¡):`, error?.message);
    
    if (this.consecutiveErrors >= 10) {
      console.error('è¿ç»­é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œè¯·æ£€æŸ¥TRONç½‘ç»œè¿æ¥');
    }
  }
}
```

### è‡ªå®šä¹‰é”™è¯¯ç±»å‹

```typescript
// âœ… æ¨èï¼šåˆ›å»ºä¸“é—¨çš„é”™è¯¯ç±»
class AuthenticationError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'AuthenticationError';
  }
}

class ValidationError extends Error {
  constructor(public field: string, message: string) {
    super(message);
    this.name = 'ValidationError';
  }
}

// âœ… æ¨èï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­æŠ›å‡ºç‰¹å®šé”™è¯¯
async function createUser(userData: CreateUserParams): Promise<User> {
  if (!userData.username) {
    throw new ValidationError('username', 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
  }
  
  if (!userData.password) {
    throw new ValidationError('password', 'å¯†ç ä¸èƒ½ä¸ºç©º');
  }
  
  try {
    const hashedPassword = await bcrypt.hash(userData.password, 10);
    // åˆ›å»ºç”¨æˆ·é€»è¾‘
  } catch (error) {
    throw new AuthenticationError('å¯†ç åŠ å¯†å¤±è´¥');
  }
}
```

### ä¸­é—´ä»¶é”™è¯¯å¤„ç†

```typescript
// âœ… æ¨èï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶
export const errorHandler = (
  error: Error,
  req: Request,
  res: Response<ApiResponse>,
  next: NextFunction
): void => {
  console.error('æœªå¤„ç†çš„é”™è¯¯:', error);

  // ç‰¹å®šé”™è¯¯ç±»å‹å¤„ç†
  if (error.message.includes('SQLITE')) {
    res.status(500).json({
      success: false,
      error: 'æ•°æ®åº“æ“ä½œå¤±è´¥'
    });
    return;
  }

  if (error.name === 'JsonWebTokenError') {
    res.status(401).json({
      success: false,
      error: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ'
    });
    return;
  }

  // é»˜è®¤é”™è¯¯å¤„ç†
  res.status(500).json({
    success: false,
    error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  });
};
```

**ç« èŠ‚æ¥æº**
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L60-L120)
- [src/middleware/auth.ts](file://src/middleware/auth.ts#L40-L80)

## å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ

### async/awaitä½¿ç”¨è§„èŒƒ

é¡¹ç›®å…¨é¢é‡‡ç”¨async/awaitè¯­æ³•ï¼Œé¿å…å›è°ƒåœ°ç‹±ï¼š

```typescript
// âœ… æ¨èï¼šä½¿ç”¨async/awaitå¤„ç†å¼‚æ­¥æ“ä½œ
public async startPolling(callback: (blockInfo: BlockInfo) => void): void {
  if (this.isPolling) {
    console.warn('RPCè½®è¯¢å·²åœ¨è¿è¡Œä¸­');
    return;
  }

  this.onBlockCallback = callback;
  this.isPolling = true;
  this.consecutiveErrors = 0;

  console.log(`å¼€å§‹TRON RPCè½®è¯¢ï¼Œé—´éš”: ${this.pollingInterval}ms`);

  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  await this._executePolling();

  // è®¾ç½®å®šæ—¶å™¨
  this.pollingTimer = setInterval(async () => {
    await this._executePolling();
  }, this.pollingInterval);
}

// âœ… æ¨èï¼šæ‰¹é‡å¼‚æ­¥æ“ä½œä½¿ç”¨Promise.all
router.get('/stats', authenticateToken, async (req, res) => {
  try {
    const [todayStats, currentBlock, hourlyStats] = await Promise.all([
      BlockModel.getTodayStats(),
      BlockModel.getLatest(),
      BlockModel.getTodayHourlyStats()
    ]);

    res.json({
      success: true,
      data: {
        todayTotal: todayStats.total,
        todayOdd: todayStats.odd,
        todayEven: todayStats.even,
        hourlyStats: hourlyStats,
        currentBlock: currentBlock ? {
          number: currentBlock.block_number,
          hash: currentBlock.block_hash,
          timestamp: currentBlock.timestamp,
          lastDigit: currentBlock.last_digit,
          isOdd: currentBlock.is_odd
        } : null
      }
    });

  } catch (error) {
    console.error('è·å–ç»Ÿè®¡æ•°æ®é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});
```

### é”™è¯¯ä¼ æ’­ä¸å¤„ç†

```typescript
// âœ… æ¨èï¼šæ­£ç¡®çš„é”™è¯¯ä¼ æ’­æ–¹å¼
public async testConnection(): Promise<{ success: boolean; latency?: number; error?: string }> {
  const startTime = Date.now();
  
  try {
    await this.getLatestBlock();
    const latency = Date.now() - startTime;
    
    return {
      success: true,
      latency
    };
  } catch (error: any) {
    return {
      success: false,
      error: error?.message || 'æœªçŸ¥é”™è¯¯'
    };
  }
}

// âœ… æ¨èï¼šåœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–
public async start(): Promise<void> {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“
    await database.connect();
    await database.initializeTables();
    
    // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    await this.createDefaultAdmin();
    
    // å¯åŠ¨TRONæ•°æ®é‡‡é›†
    await this.blockDataService.start();
    
    // å¯åŠ¨ExpressæœåŠ¡å™¨
    this.app.listen(config.port, () => {
      console.log(`ğŸš€ Point-TronæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`);
      console.log(`ğŸ“¡ æœåŠ¡åœ°å€: http://localhost:${config.port}`);
    });
    
  } catch (error) {
    console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L30-L80)
- [src/routes/blocks.ts](file://src/routes/blocks.ts#L10-L50)
- [src/index.ts](file://src/index.ts#L80-L120)

## æ—¥å¿—è®°å½•ç­–ç•¥

### ç»“æ„åŒ–æ—¥å¿—è®°å½•

é¡¹ç›®é‡‡ç”¨ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•æ–¹å¼ï¼š

```typescript
// âœ… æ¨èï¼šä½¿ç”¨console.logè®°å½•å…³é”®ä¿¡æ¯
console.log(`å¼€å§‹TRON RPCè½®è¯¢ï¼Œé—´éš”: ${this.pollingInterval}ms`);
console.log(`å°è¯•ç¬¬${attempt}æ¬¡è¯·æ±‚: ${url}`);
console.log(`ç­‰å¾…${delay}msåé‡è¯•...`);

// âœ… æ¨èï¼šä½¿ç”¨warnè®°å½•è­¦å‘Šä¿¡æ¯
console.warn(`è¯·æ±‚å°è¯•${attempt}å¤±è´¥:`, error?.message);
console.warn(`åŒºå—å“ˆå¸Œä¸­æœªæ‰¾åˆ°æ•°å­—: ${hash}`);

// âœ… æ¨èï¼šä½¿ç”¨errorè®°å½•é”™è¯¯ä¿¡æ¯
console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
console.error('åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜å¤±è´¥:', error);
console.error(`RPCè½®è¯¢é”™è¯¯ (è¿ç»­ç¬¬${this.consecutiveErrors}æ¬¡):`, error?.message);
```

### è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

```typescript
// âœ… æ¨èï¼šå®ç°è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
export const requestLogger = (req: Request, res: Response, next: NextFunction): void => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    console.log(
      `${req.method} ${req.path} - ${res.statusCode} - ${duration}ms - ${req.ip}`
    );
  });
  
  next();
};
```

### è°ƒè¯•å’Œç›‘æ§

```typescript
// âœ… æ¨èï¼šåœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•ä¿¡æ¯
private async _executePolling(): Promise<void> {
  try {
    const latestBlock = await this.getLatestBlock();
    
    if (this.onBlockCallback) {
      this.onBlockCallback(latestBlock);
    }
    
    this.consecutiveErrors = 0;
    this.lastBlockTime = Date.now();
    console.log('åŒºå—è½®è¯¢æˆåŠŸå®Œæˆ');

  } catch (error: any) {
    this.consecutiveErrors++;
    console.error(`RPCè½®è¯¢é”™è¯¯ (è¿ç»­ç¬¬${this.consecutiveErrors}æ¬¡):`, error?.message);
    
    if (this.consecutiveErrors >= 10) {
      console.error('è¿ç»­é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œè¯·æ£€æŸ¥TRONç½‘ç»œè¿æ¥');
    }
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L70-L120)
- [src/middleware/auth.ts](file://src/middleware/auth.ts#L70-L85)

## å•å…ƒæµ‹è¯•åŸåˆ™

### æµ‹è¯•æ–‡ä»¶ç»„ç»‡

è™½ç„¶é¡¹ç›®ç›®å‰ä¸»è¦ä½¿ç”¨é›†æˆæµ‹è¯•ï¼Œä½†å»ºè®®é‡‡ç”¨ä»¥ä¸‹æµ‹è¯•ç»„ç»‡ç»“æ„ï¼š

```typescript
// âœ… æ¨èï¼šæµ‹è¯•æ–‡ä»¶å‘½åè§„èŒƒ
// src/services/__tests__/TronRPCService.test.ts
// src/models/__tests__/UserModel.test.ts
// src/routes/__tests__/auth.test.ts

// âœ… æ¨èï¼šæµ‹è¯•ç”¨ä¾‹ç»“æ„
describe('TronRPCService', () => {
  let service: TronRPCService;
  
  beforeEach(() => {
    service = new TronRPCService();
  });
  
  describe('getLatestBlock', () => {
    it('åº”è¯¥è¿”å›æœ‰æ•ˆçš„åŒºå—ä¿¡æ¯', async () => {
      // æµ‹è¯•å®ç°
    });
    
    it('åº”è¯¥åœ¨é”™è¯¯æ—¶æ­£ç¡®å¤„ç†', async () => {
      // æµ‹è¯•å®ç°
    });
  });
});
```

### æµ‹è¯•å·¥å…·ä½¿ç”¨

é¡¹ç›®ä½¿ç”¨Jestè¿›è¡Œå•å…ƒæµ‹è¯•ï¼š

```json
{
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "jest": "^29.7.0",
    "@types/jest": "^29.5.8"
  }
}
```

### æµ‹è¯•æœ€ä½³å®è·µ

```typescript
// âœ… æ¨èï¼šä½¿ç”¨æ¨¡æ‹Ÿå’Œå­˜æ ¹
import { jest } from '@jest/globals';

describe('AuthService', () => {
  it('åº”è¯¥æ­£ç¡®ç”ŸæˆJWTä»¤ç‰Œ', () => {
    const user = { id: 1, username: 'test' };
    const token = AuthService.generateToken(user);
    
    expect(token).toBeDefined();
    expect(typeof token).toBe('string');
  });
  
  it('åº”è¯¥éªŒè¯æœ‰æ•ˆçš„JWTä»¤ç‰Œ', () => {
    const user = { id: 1, username: 'test' };
    const token = AuthService.generateToken(user);
    const decoded = AuthService.verifyToken(token);
    
    expect(decoded).toBeDefined();
    expect(decoded?.userId).toBe(1);
  });
});
```

**ç« èŠ‚æ¥æº**
- [package.json](file://package.json#L8-L12)
- [test.js](file://test.js#L1-L50)

## ä»£ç å®¡æŸ¥æ¸…å•

### ä»£ç è´¨é‡æ£€æŸ¥

ä»¥ä¸‹æ˜¯é¡¹ç›®éµå¾ªçš„ä¸»è¦ä»£ç å®¡æŸ¥æ ‡å‡†ï¼š

1. **ç±»å‹å®‰å…¨æ€§**
   - [ ] æ‰€æœ‰å‡½æ•°éƒ½æœ‰æ˜ç¡®çš„è¿”å›ç±»å‹
   - [ ] é¿å…ä½¿ç”¨`any`ç±»å‹
   - [ ] æ­£ç¡®ä½¿ç”¨æ¥å£å’Œç±»å‹åˆ«å
   - [ ] ä½¿ç”¨ç±»å‹å®ˆå«ç¡®ä¿ç±»å‹å®‰å…¨

2. **é”™è¯¯å¤„ç†**
   - [ ] å…³é”®æ“ä½œéƒ½åŒ…å«try-catch
   - [ ] é”™è¯¯ä¿¡æ¯å…·æœ‰æè¿°æ€§
   - [ ] ç‰¹å®šé”™è¯¯ç±»å‹å¾—åˆ°é€‚å½“å¤„ç†
   - [ ] èµ„æºæ¸…ç†åœ¨finallyå—ä¸­å®Œæˆ

3. **å¼‚æ­¥ç¼–ç¨‹**
   - [ ] ä½¿ç”¨async/awaitè€Œéå›è°ƒ
   - [ ] æ­£ç¡®å¤„ç†å¹¶å‘æ“ä½œ
   - [ ] é¿å…Promiseæ»¥ç”¨
   - [ ] åˆç†ä½¿ç”¨Promise.all

4. **å‘½åè§„èŒƒ**
   - [ ] å˜é‡ä½¿ç”¨é©¼å³°å¼å‘½å
   - [ ] ç±»ä½¿ç”¨å¸•æ–¯å¡å¼å‘½å
   - [ ] æ¥å£ä½¿ç”¨å¸•æ–¯å¡å¼å‘½å
   - [ ] ç§æœ‰æ–¹æ³•ä»¥ä¸‹åˆ’çº¿å¼€å¤´

5. **ä»£ç ç»“æ„**
   - [ ] å‡½æ•°é•¿åº¦ä¸è¶…è¿‡50è¡Œ
   - [ ] ç±»èŒè´£å•ä¸€
   - [ ] é¿å…é‡å¤ä»£ç 
   - [ ] åˆç†ä½¿ç”¨è®¾è®¡æ¨¡å¼

### ä»£ç å®¡æŸ¥å·¥å…·

```json
{
  "scripts": {
    "dev": "ts-node src/index.ts",
    "build": "tsc && mkdir -p dist/views && cp src/views/*.ejs dist/views/"
  },
  "devDependencies": {
    "typescript": "^5.9.2",
    "ts-node": "^10.9.1"
  }
}
```

**ç« èŠ‚æ¥æº**
- [package.json](file://package.json#L1-L39)

## JSDocæ³¨é‡Šè§„èŒƒ

### å‡½æ•°æ³¨é‡Š

```typescript
/**
 * ä»è¯·æ±‚å¤´ä¸­æå–JWTä»¤ç‰Œ
 * 
 * @param authHeader - Authorizationå¤´éƒ¨å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸º"Bearer token"æˆ–ç›´æ¥token
 * @returns æå–çš„ä»¤ç‰Œå­—ç¬¦ä¸²ï¼Œå¦‚æœæ— æ³•æå–åˆ™è¿”å›null
 * 
 * @example
 * const token = AuthService.extractTokenFromHeader('Bearer abc123');
 * console.log(token); // 'abc123'
 */
static extractTokenFromHeader(authHeader: string | undefined): string | null {
  if (!authHeader) {
    return null;
  }

  const parts = authHeader.split(' ');
  if (parts.length === 2 && parts[0] === 'Bearer') {
    return parts[1];
  }

  return authHeader;
}
```

### ç±»æ³¨é‡Š

```typescript
/**
 * TRONåŒºå—é“¾RPCæœåŠ¡
 * 
 * è´Ÿè´£ä¸TRONç½‘ç»œè¿›è¡Œäº¤äº’ï¼Œè·å–åŒºå—ä¿¡æ¯å’Œæ‰§è¡Œç›¸å…³æ“ä½œ
 * 
 * @example
 * const rpcService = new TronRPCService();
 * const block = await rpcService.getLatestBlock();
 * console.log(block.block_number);
 */
export class TronRPCService {
  /**
   * å¯åŠ¨åŒºå—è½®è¯¢
   * 
   * @param callback - å½“æ£€æµ‹åˆ°æ–°åŒºå—æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°
   */
  public startPolling(callback: (blockInfo: BlockInfo) => void): void {
    // å®ç°
  }
}
```

### æ¥å£æ³¨é‡Š

```typescript
/**
 * åŒºå—ä¿¡æ¯æ¥å£
 * 
 * æè¿°TRONåŒºå—é“¾åŒºå—çš„åŸºæœ¬å±æ€§
 */
export interface BlockInfo {
  /** åŒºå—å”¯ä¸€æ ‡è¯†ç¬¦ */
  id?: number;
  
  /** åŒºå—é«˜åº¦ */
  block_number: number;
  
  /** åŒºå—å“ˆå¸Œå€¼ */
  block_hash: string;
  
  /** æ—¶é—´æˆ³ */
  timestamp: number;
  
  /** æœ€åä¸€ä½æ•°å­— */
  last_digit: number;
  
  /** æ˜¯å¦ä¸ºå¥‡æ•° */
  is_odd: boolean;
  
  /** åˆ›å»ºæ—¶é—´ */
  created_at?: string;
}
```

### å‚æ•°å’Œè¿”å›å€¼æ³¨é‡Š

```typescript
/**
 * éªŒè¯ç”¨æˆ·å‡­æ®
 * 
 * @param username - ç”¨æˆ·å
 * @param password - å¯†ç 
 * @returns å¦‚æœéªŒè¯æˆåŠŸè¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œå¦åˆ™è¿”å›null
 * 
 * @throws {Error} å½“æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
 */
static async verifyPassword(username: string, password: string): Promise<User | null> {
  const user = await this.findByUsername(username);
  if (!user) {
    return null;
  }

  const isValidPassword = await bcrypt.compare(password, user.password);
  if (!isValidPassword) {
    return null;
  }

  return user;
}
```

**ç« èŠ‚æ¥æº**
- [src/services/AuthService.ts](file://src/services/AuthService.ts#L20-L40)
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L15-L35)
- [src/models/types.ts](file://src/models/types.ts#L1-L20)

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å†…å­˜ç®¡ç†

```typescript
// âœ… æ¨èï¼šåŠæ—¶æ¸…ç†å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨
public stopPolling(): void {
  if (this.pollingTimer) {
    clearInterval(this.pollingTimer);
    this.pollingTimer = null;
  }
  this.isPolling = false;
  this.onBlockCallback = null;
  console.log('TRON RPCè½®è¯¢å·²åœæ­¢');
}

// âœ… æ¨èï¼šåœ¨åº”ç”¨å…³é—­æ—¶æ¸…ç†èµ„æº
public async shutdown(): Promise<void> {
  console.log('æ­£åœ¨å…³é—­åº”ç”¨...');
  
  // åœæ­¢TRONæ•°æ®é‡‡é›†
  this.blockDataService.stop();
  
  // å…³é—­æ•°æ®åº“è¿æ¥
  await database.close();
  
  console.log('åº”ç”¨å·²å®‰å…¨å…³é—­');
  process.exit(0);
}
```

### å¹¶å‘æ§åˆ¶

```typescript
// âœ… æ¨èï¼šä½¿ç”¨é€Ÿç‡é™åˆ¶é˜²æ­¢è¿‡åº¦è¯·æ±‚
const rateLimitMap = new Map<string, { count: number; resetTime: number }>();

export const rateLimit = (maxRequests: number = 100, windowMs: number = 60000) => {
  return (req: Request, res: Response, next: NextFunction): void => {
    const clientIp = req.ip || req.connection.remoteAddress || 'unknown';
    const now = Date.now();
    
    const clientData = rateLimitMap.get(clientIp);
    
    if (!clientData || now > clientData.resetTime) {
      // é‡ç½®æˆ–åˆå§‹åŒ–
      rateLimitMap.set(clientIp, {
        count: 1,
        resetTime: now + windowMs
      });
      next();
      return;
    }
    
    if (clientData.count >= maxRequests) {
      res.status(429).json({
        success: false,
        error: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
      });
      return;
    }
    
    clientData.count++;
    next();
  };
};
```

### ç¼“å­˜ç­–ç•¥

```typescript
// âœ… æ¨èï¼šå®ç°ç®€å•çš„ç¼“å­˜æœºåˆ¶
class CacheManager {
  private cache = new Map<string, { data: any; expires: number }>();
  
  public set(key: string, data: any, ttl: number = 300000): void {
    this.cache.set(key, {
      data,
      expires: Date.now() + ttl
    });
  }
  
  public get<T>(key: string): T | null {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() > item.expires) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }
}
```

**ç« èŠ‚æ¥æº**
- [src/services/TronRPCService.ts](file://src/services/TronRPCService.ts#L45-L60)
- [src/middleware/auth.ts](file://src/middleware/auth.ts#L120-L170)
- [src/index.ts](file://src/index.ts#L140-L163)

## æ€»ç»“

æœ¬é¡¹ç›®å±•ç¤ºäº†ç°ä»£TypeScriptå¼€å‘çš„æœ€ä½³å®è·µï¼Œæ¶µç›–äº†ä»åŸºç¡€é…ç½®åˆ°é«˜çº§ç‰¹æ€§çš„å„ä¸ªæ–¹é¢ã€‚é€šè¿‡éµå¾ªè¿™äº›ç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µï¼Œå¼€å‘è€…å¯ä»¥ï¼š

1. **æé«˜ä»£ç è´¨é‡**ï¼šé€šè¿‡ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥å’Œé”™è¯¯å¤„ç†ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
2. **å¢å¼ºå¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„å‘½åçº¦å®šå’Œç»“æ„åŒ–ä»£ç ä½¿é¡¹ç›®æ˜“äºç†è§£å’Œç»´æŠ¤
3. **æå‡å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„è§„èŒƒå‡å°‘äº†å›¢é˜Ÿåä½œä¸­çš„æ²Ÿé€šæˆæœ¬
4. **ç¡®ä¿é•¿æœŸç¨³å®šæ€§**ï¼šè‰¯å¥½çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†ç­–ç•¥ä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œ

å»ºè®®å›¢é˜Ÿåœ¨æ—¥å¸¸å¼€å‘ä¸­æŒç»­å…³æ³¨è¿™äº›è§„èŒƒï¼Œå¹¶æ ¹æ®é¡¹ç›®å‘å±•éœ€è¦é€‚æ—¶è°ƒæ•´å’Œå®Œå–„ã€‚åŒæ—¶ï¼Œé¼“åŠ±å›¢é˜Ÿæˆå‘˜ç§¯æå‚ä¸ä»£ç å®¡æŸ¥ï¼Œå…±åŒç»´æŠ¤é«˜è´¨é‡çš„ä»£ç åº“ã€‚