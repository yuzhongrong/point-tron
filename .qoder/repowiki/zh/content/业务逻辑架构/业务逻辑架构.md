# 业务逻辑架构文档

<cite>
**本文档引用的文件**
- [TronRPCService.ts](file://src/services/TronRPCService.ts)
- [BlockDataService.ts](file://src/services/BlockDataService.ts)
- [AuthService.ts](file://src/services/AuthService.ts)
- [index.ts](file://src/index.ts)
- [types.ts](file://src/models/types.ts)
- [BlockModel.ts](file://src/models/BlockModel.ts)
- [DailyStatsModel.ts](file://src/models/DailyStatsModel.ts)
- [BlockPointsModel.ts](file://src/models/BlockPointsModel.ts)
- [database/index.ts](file://src/database/index.ts)
- [config/index.ts](file://src/config/index.ts)
- [middleware/auth.ts](file://src/middleware/auth.ts)
- [routes/blocks.ts](file://src/routes/blocks.ts)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构概览](#系统架构概览)
3. [核心服务组件](#核心服务组件)
4. [数据流分析](#数据流分析)
5. [服务间依赖关系](#服务间依赖关系)
6. [时序图说明](#时序图说明)
7. [性能优化策略](#性能优化策略)
8. [故障处理机制](#故障处理机制)
9. [总结](#总结)

## 概述

本系统是一个基于TRON区块链的区块数据分析平台，主要功能包括：
- 实时监控TRON网络区块产生
- 自动采集、处理和存储区块数据
- 提供区块打点计分系统
- 实现完整的用户认证和授权机制
- 提供RESTful API接口和Web管理界面

系统采用模块化设计，通过依赖注入实现服务解耦，确保代码的可维护性和扩展性。

## 系统架构概览

```mermaid
graph TB
subgraph "外部层"
Client[客户端应用]
Browser[Web浏览器]
end
subgraph "网络层"
API[RESTful API]
WebUI[Web管理界面]
end
subgraph "服务层"
TronRPC[TronRPCService<br/>TRON网络交互]
BlockData[BlockDataService<br/>数据处理协调]
Auth[AuthService<br/>JWT认证管理]
end
subgraph "数据层"
SQLite[(SQLite数据库)]
Models[数据模型层]
end
subgraph "配置层"
Config[配置管理]
Middleware[中间件层]
end
Client --> API
Browser --> WebUI
API --> TronRPC
API --> BlockData
API --> Auth
WebUI --> Auth
TronRPC --> Models
BlockData --> Models
Models --> SQLite
API --> Middleware
Auth --> Middleware
Config --> TronRPC
Config --> BlockData
```

**图表来源**
- [index.ts](file://src/index.ts#L1-L163)
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L1-L258)
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L273)

## 核心服务组件

### TronRPCService - TRON网络交互服务

TronRPCService是系统的核心网络通信组件，负责与TRON区块链网络进行交互。

```mermaid
classDiagram
class TronRPCService {
-rpcUrl : string
-timeout : number
-retryTimes : number
-pollingInterval : number
-pollingTimer : NodeJS.Timeout
-isPolling : boolean
-consecutiveErrors : number
-lastBlockTime : number
-onBlockCallback : Function
+constructor(rpcConfig)
+startPolling(callback)
+stopPolling()
+getLatestBlock() Promise~BlockInfo~
+getBlockByNumber(number) Promise~BlockInfo~
+testConnection() Promise~Object~
+getPollingStatus() Object
+updateConfig(newConfig)
-executePolling() Promise~void~
-makeHttpRequest(endpoint, data) Promise~Object~
-parseTronBlockResponse(data) BlockInfo
-parseBlockHash(hash) number
}
class TronRPCConfig {
+rpcUrl : string
+timeout : number
+retryTimes : number
+pollingInterval : number
}
class BlockInfo {
+block_number : number
+block_hash : string
+timestamp : number
+last_digit : number
+is_odd : boolean
}
TronRPCService --> TronRPCConfig : "配置使用"
TronRPCService --> BlockInfo : "生成"
```

**图表来源**
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L15-L258)
- [types.ts](file://src/models/types.ts#L1-L15)

#### 关键特性

1. **轮询机制**：每3秒自动轮询获取最新区块
2. **重试机制**：支持指数退避重试策略，最多重试3次
3. **超时控制**：支持自定义请求超时时间（默认5秒）
4. **错误处理**：连续错误超过10次会发出警告
5. **状态监控**：提供详细的轮询状态信息

#### HTTP请求处理流程

```mermaid
sequenceDiagram
participant Client as "调用方"
participant RPC as "TronRPCService"
participant Network as "TRON网络"
participant Parser as "数据解析器"
Client->>RPC : getLatestBlock()
RPC->>RPC : makeHttpRequest()
loop 最多3次重试
RPC->>Network : POST /wallet/getnowblock
Network-->>RPC : 原始区块数据
alt 请求成功
RPC->>Parser : parseTronBlockResponse()
Parser-->>RPC : BlockInfo对象
RPC-->>Client : 返回区块信息
else 请求失败
RPC->>RPC : 指数退避延迟
end
end
RPC-->>Client : 抛出最终错误
```

**图表来源**
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L70-L120)

**章节来源**
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L1-L258)

### BlockDataService - 数据处理协调服务

BlockDataService作为数据处理的核心协调器，负责协调各个数据处理环节。

```mermaid
classDiagram
class BlockDataService {
-tronRPCService : TronRPCService
-isRunning : boolean
-lastProcessedBlock : number
-statsCache : Object
+constructor(tronRPCService)
+start() Promise~void~
+stop() void
+getStatus() Object
+getRealTimeStats() Promise~Object~
+syncBlocks(fromBlock, toBlock) Promise~number~
+healthCheck() Promise~Object~
-onNewBlock(blockInfo) Promise~void~
-updateStatsCache(blockInfo) void
-refreshStatsCache() Promise~void~
}
class TronRPCService {
+startPolling(callback)
+stopPolling()
+getLatestBlock() Promise~BlockInfo~
}
class BlockModel {
+create(blockInfo) Promise~number~
+getLatest() Promise~BlockInfo~
+getTodayStats() Promise~Object~
}
class DailyStatsModel {
+updateTodayStats(oddInc, evenInc) Promise~void~
+getTodayStats() Promise~DailyStats~
}
class BlockPointsModel {
+addBlockPoint(...) Promise~BlockPoint~
+getCurrentScore() Promise~number~
}
BlockDataService --> TronRPCService : "依赖"
BlockDataService --> BlockModel : "使用"
BlockDataService --> DailyStatsModel : "使用"
BlockDataService --> BlockPointsModel : "使用"
```

**图表来源**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L8-L273)
- [BlockModel.ts](file://src/models/BlockModel.ts#L1-L170)
- [DailyStatsModel.ts](file://src/models/DailyStatsModel.ts#L1-L165)
- [BlockPointsModel.ts](file://src/models/BlockPointsModel.ts#L1-L219)

#### 数据处理流程

```mermaid
flowchart TD
Start([开始处理区块]) --> CheckBlock{"检查区块<br/>是否已处理"}
CheckBlock --> |已处理| Skip[跳过处理]
CheckBlock --> |未处理| SaveBlock[保存区块数据到数据库]
SaveBlock --> UpdateStats[更新每日统计]
UpdateStats --> AddPoints[添加区块打点数据]
AddPoints --> UpdateCache[更新统计缓存]
UpdateCache --> UpdateLast[更新最后处理区块号]
UpdateLast --> LogSuccess[记录处理成功]
LogSuccess --> End([处理完成])
Skip --> End
SaveBlock --> |失败| LogError[记录错误]
LogError --> End
```

**图表来源**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L50-L85)

**章节来源**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L1-L273)

### AuthService - JWT认证服务

AuthService专门负责JWT令牌的生成、验证和刷新等认证相关功能。

```mermaid
classDiagram
class AuthService {
<<static>>
+generateToken(user) string
+verifyToken(token) JWTPayload
+extractTokenFromHeader(header) string
+isTokenExpiringSoon(token) boolean
+refreshToken(oldToken) string
+getTokenRemainingTime(token) number
}
class JWTPayload {
+userId : number
+username : string
+iat? : number
+exp? : number
}
class User {
+id? : number
+username : string
+password : string
+created_at? : string
+updated_at? : string
}
AuthService --> JWTPayload : "生成/验证"
AuthService --> User : "处理"
```

**图表来源**
- [AuthService.ts](file://src/services/AuthService.ts#L1-L104)
- [types.ts](file://src/models/types.ts#L10-L20)

#### JWT生命周期管理

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "API端点"
participant Auth as "AuthService"
participant DB as "用户数据库"
Note over Client,DB : 登录流程
Client->>API : POST /api/auth/login
API->>DB : 验证用户凭据
DB-->>API : 用户信息
API->>Auth : generateToken(user)
Auth-->>API : JWT令牌
API-->>Client : 返回令牌
Note over Client,DB : 正常请求流程
Client->>API : 请求 + Authorization头
API->>Auth : verifyToken(token)
Auth-->>API : 验证结果
API->>DB : 查找用户
DB-->>API : 用户信息
API-->>Client : 返回资源
Note over Client,DB : 令牌刷新流程
Client->>API : 请求刷新令牌
API->>Auth : refreshToken(oldToken)
Auth-->>API : 新令牌
API-->>Client : 返回新令牌
```

**图表来源**
- [AuthService.ts](file://src/services/AuthService.ts#L10-L104)
- [middleware/auth.ts](file://src/middleware/auth.ts#L15-L50)

**章节来源**
- [AuthService.ts](file://src/services/AuthService.ts#L1-L104)

## 数据流分析

### 区块数据采集流程

系统从TRON网络获取区块数据的完整流程如下：

```mermaid
sequenceDiagram
participant Timer as "轮询定时器"
participant RPC as "TronRPCService"
participant Parser as "区块解析器"
participant DataService as "BlockDataService"
participant DB as "数据库"
participant Cache as "统计缓存"
Timer->>RPC : 触发轮询
RPC->>RPC : makeHttpRequest()
RPC->>Parser : parseTronBlockResponse()
Parser-->>RPC : BlockInfo对象
RPC->>DataService : onNewBlock(blockInfo)
DataService->>DataService : 检查区块唯一性
DataService->>DB : BlockModel.create()
DB-->>DataService : 区块ID
DataService->>DB : DailyStatsModel.updateTodayStats()
DataService->>DB : BlockPointsModel.addBlockPoint()
DataService->>Cache : updateStatsCache()
DataService-->>RPC : 处理完成
RPC-->>Timer : 下次轮询
```

**图表来源**
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L40-L70)
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L50-L85)

### 数据存储架构

```mermaid
erDiagram
BLOCKS {
int id PK
bigint block_number UK
varchar block_hash
bigint timestamp
int last_digit
boolean is_odd
timestamp created_at
}
DAILY_STATS {
int id PK
date date UK
int total_blocks
int odd_count
int even_count
timestamp updated_at
}
BLOCK_POINTS {
int id PK
bigint block_number UK
varchar block_hash
bigint timestamp
int last_digit
boolean is_odd
int point_change
int cumulative_score
timestamp created_at
}
USERS {
int id PK
varchar username UK
varchar password
timestamp created_at
timestamp updated_at
}
CONFIG {
int id PK
varchar key UK
text value
varchar description
timestamp updated_at
}
BLOCKS ||--|| DAILY_STATS : "每日统计关联"
BLOCKS ||--|| BLOCK_POINTS : "打点数据关联"
USERS ||--{} CONFIG : "系统配置"
```

**图表来源**
- [BlockModel.ts](file://src/models/BlockModel.ts#L1-L50)
- [DailyStatsModel.ts](file://src/models/DailyStatsModel.ts#L1-L50)
- [BlockPointsModel.ts](file://src/models/BlockPointsModel.ts#L1-L50)

**章节来源**
- [BlockModel.ts](file://src/models/BlockModel.ts#L1-L170)
- [DailyStatsModel.ts](file://src/models/DailyStatsModel.ts#L1-L165)
- [BlockPointsModel.ts](file://src/models/BlockPointsModel.ts#L1-L219)

## 服务间依赖关系

### 依赖注入架构

```mermaid
graph TB
subgraph "应用层"
App[App应用类]
end
subgraph "服务层"
TronRPC[TronRPCService]
BlockData[BlockDataService]
Auth[AuthService]
end
subgraph "模型层"
BlockModel[BlockModel]
DailyStatsModel[DailyStatsModel]
BlockPointsModel[BlockPointsModel]
UserModel[UserModel]
end
subgraph "基础设施层"
Database[(SQLite数据库)]
Config[配置管理]
JWT[JWT库]
end
App --> TronRPC
App --> BlockData
App --> Auth
BlockData --> TronRPC
BlockData --> BlockModel
BlockData --> DailyStatsModel
BlockData --> BlockPointsModel
Auth --> JWT
BlockModel --> Database
DailyStatsModel --> Database
BlockPointsModel --> Database
UserModel --> Database
TronRPC --> Config
BlockData --> Config
```

**图表来源**
- [index.ts](file://src/index.ts#L20-L30)
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L15-L20)

### 服务启动顺序

系统启动时的服务初始化遵循严格的依赖顺序：

1. **数据库连接**：首先建立数据库连接
2. **默认管理员创建**：确保系统有初始管理员账户
3. **TRON RPC服务启动**：开始区块轮询
4. **区块数据服务启动**：协调数据处理流程
5. **Express服务器启动**：提供API和Web服务

**章节来源**
- [index.ts](file://src/index.ts#L80-L120)

## 时序图说明

### 完整的数据采集到入库流程

```mermaid
sequenceDiagram
participant Timer as "3秒定时器"
participant RPC as "TronRPCService"
participant API as "TRON API"
participant Parser as "区块解析器"
participant DataService as "BlockDataService"
participant BlockDB as "BlockModel"
participant StatsDB as "DailyStatsModel"
participant PointsDB as "BlockPointsModel"
participant Cache as "统计缓存"
Note over Timer,Cache : 第一次轮询触发
Timer->>RPC : executePolling()
RPC->>API : GET /wallet/getnowblock
API-->>RPC : 原始区块数据
RPC->>Parser : parseTronBlockResponse()
Parser-->>RPC : BlockInfo对象
RPC->>DataService : onNewBlock(BlockInfo)
Note over DataService,Cache : 处理新区块
DataService->>DataService : 检查区块唯一性
DataService->>BlockDB : create(BlockInfo)
BlockDB-->>DataService : 区块ID
DataService->>StatsDB : updateTodayStats()
DataService->>PointsDB : addBlockPoint()
DataService->>Cache : updateStatsCache()
DataService-->>RPC : 处理完成
Note over Timer,Cache : 后续轮询
Timer->>RPC : executePolling()
RPC->>API : GET /wallet/getnowblock
API-->>RPC : 新区块数据
RPC->>DataService : onNewBlock(newBlock)
DataService->>DataService : 检查区块唯一性
DataService->>BlockDB : create(newBlock)
BlockDB-->>DataService : 区块ID
DataService->>StatsDB : updateTodayStats()
DataService->>PointsDB : addBlockPoint()
DataService->>Cache : updateStatsCache()
DataService-->>RPC : 处理完成
```

**图表来源**
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L40-L70)
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L50-L85)

## 性能优化策略

### 缓存机制

系统实现了多层次的缓存机制来提升性能：

1. **统计缓存**：在内存中缓存当日统计数据，减少数据库查询
2. **索引优化**：为关键查询字段创建数据库索引
3. **批量处理**：在数据同步时采用批量插入策略

### 数据清理策略

```mermaid
flowchart TD
Start([定期任务启动]) --> CheckAge{"检查数据年龄"}
CheckAge --> |超过30天| CleanBlocks[清理过期区块数据]
CheckAge --> |超过90天| CleanStats[清理过期统计数据]
CheckAge --> |超过90天| CleanPoints[清理过期打点数据]
CleanBlocks --> UpdateIndex[更新数据库索引]
CleanStats --> UpdateIndex
CleanPoints --> UpdateIndex
UpdateIndex --> LogResult[记录清理结果]
LogResult --> End([任务完成])
```

**图表来源**
- [BlockModel.ts](file://src/models/BlockModel.ts#L100-L120)
- [DailyStatsModel.ts](file://src/models/DailyStatsModel.ts#L140-L165)
- [BlockPointsModel.ts](file://src/models/BlockPointsModel.ts#L180-L200)

### 并发处理优化

系统采用异步并发处理来提高效率：

- **并行API调用**：在获取统计数据时并行执行多个查询
- **批量数据库操作**：在数据同步时采用事务批量插入
- **非阻塞I/O**：所有网络请求和数据库操作都采用异步模式

## 故障处理机制

### 错误恢复策略

```mermaid
flowchart TD
Error([检测到错误]) --> CheckType{"错误类型判断"}
CheckType --> |网络错误| Retry[指数退避重试]
CheckType --> |数据库错误| Fallback[降级处理]
CheckType --> |配置错误| Alert[发送告警]
Retry --> MaxRetry{"达到最大重试次数?"}
MaxRetry --> |否| Wait[等待延迟]
MaxRetry --> |是| Fallback
Wait --> Retry
Fallback --> LogError[记录错误日志]
Alert --> LogError
LogError --> Notify[通知运维团队]
Notify --> End([处理完成])
```

**图表来源**
- [TronRPCService.ts](file://src/services/TronRPCService.ts#L70-L120)

### 健康检查机制

系统提供了全面的健康检查功能：

```mermaid
classDiagram
class HealthCheck {
+database : boolean
+rpcConnection : boolean
+dataIntegrity : boolean
+lastBlockAge : number
}
class BlockDataService {
+healthCheck() Promise~HealthCheck~
}
class TronRPCService {
+testConnection() Promise~Object~
+getPollingStatus() Object
}
class BlockModel {
+getLatest() Promise~BlockInfo~
}
BlockDataService --> HealthCheck : "生成"
BlockDataService --> TronRPCService : "使用"
BlockDataService --> BlockModel : "使用"
```

**图表来源**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L220-L273)

**章节来源**
- [BlockDataService.ts](file://src/services/BlockDataService.ts#L220-L273)

## 总结

本系统通过精心设计的业务逻辑架构，实现了高效、可靠的TRON区块链数据采集和处理系统。主要特点包括：

### 架构优势

1. **模块化设计**：各服务职责明确，便于维护和扩展
2. **依赖注入**：通过构造函数注入降低组件耦合度
3. **异步处理**：全面采用异步编程模式，提升系统吞吐量
4. **容错机制**：完善的错误处理和重试策略

### 核心功能

1. **实时区块监控**：3秒轮询机制确保数据及时性
2. **智能数据处理**：自动识别单双数并生成打点数据
3. **统计分析**：提供丰富的统计数据和趋势分析
4. **安全认证**：完整的JWT认证体系保障系统安全

### 扩展性考虑

系统设计充分考虑了未来的扩展需求：
- 支持多种时间范围的数据分析
- 可扩展的配置管理系统
- 灵活的插件化架构
- 完善的日志和监控体系

这种架构设计不仅满足了当前的功能需求，也为未来的功能扩展奠定了坚实的基础。